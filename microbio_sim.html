<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Hero: Microbiology Mastery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563eb;
            --primary-dark: #1e40af;
            --success-green: #10b981;
            --danger-red: #ef4444;
            --warning-yellow: #f59e0b;
            --bg-dark: #1e293b;
            --bg-medium: #334155;
            --bg-light: #475569;
            --text-light: #f1f5f9;
            --text-medium: #cbd5e1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body.high-contrast {
            --bg-dark: #000;
            --bg-medium: #111;
            --bg-light: #222;
            --text-light: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(30, 41, 59, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .title {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-blue);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .stats {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-medium);
            border-radius: 8px;
            min-width: 100px;
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-medium);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .hospital-rating {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .star {
            font-size: 1.5em;
            color: #fbbf24;
            transition: transform 0.2s;
        }

        .star.filled {
            animation: starPulse 0.5s ease;
        }

        @keyframes starPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
        }

        .btn-warning {
            background: var(--warning-yellow);
            color: black;
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-light);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .game-board {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1024px) {
            .game-board {
                grid-template-columns: 1fr;
            }
        }

        .hospital-room {
            background: rgba(51, 65, 85, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .room-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary-blue);
        }

        .patient-visual {
            width: 100%;
            height: 200px;
            background: linear-gradient(to bottom, #1e3a5f 0%, #0f1729 100%);
            border-radius: 8px;
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .patient-bed {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 60px;
            background: #8b4513;
            border-radius: 4px;
        }
        /* Detailed Nurse Figure */
        .nurse-figure-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            animation: nurseBob 2.5s ease-in-out infinite;
        }

        @keyframes nurseBob {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-8px); }
        }

        .nurse-head {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f5d5b8 0%, #e8c4a8 100%);
            border-radius: 50%;
            position: relative;
            margin: 0 auto;
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
            z-index: 10;
        }

        .nurse-hair {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 55px;
            height: 30px;
            background: linear-gradient(135deg, #4a3728 0%, #3a2718 100%);
            border-radius: 60% 60% 0 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .nurse-face {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .nurse-eye {
            position: absolute;
            top: 22px;
            width: 8px;
            height: 8px;
            background: #2c3e50;
            border-radius: 50%;
            animation: nurseBlinkEyes 4s infinite;
        }

        .nurse-eye-left { left: 16px; }
        .nurse-eye-right { right: 16px; }

        @keyframes nurseBlinkEyes {
            0%, 48%, 52%, 100% { transform: scaleY(1); opacity: 1; }
            50% { transform: scaleY(0.1); opacity: 0.5; }
        }

        .nurse-mouth {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 10px;
            border-radius: 0 0 20px 20px;
            border: 2.5px solid #c85454;
            border-top: none;
        }

        .nurse-neck {
            width: 28px;
            height: 18px;
            background: linear-gradient(135deg, #f5d5b8 0%, #e8c4a8 100%);
            margin: 0 auto;
            position: relative;
            z-index: 9;
        }

        .nurse-body {
            width: 80px;
            height: 90px;
            background: linear-gradient(135deg, #5a9fd4 0%, #4a89c4 100%);
            border-radius: 10px 10px 35px 35px;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .nurse-collar {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 15px;
            background: white;
            border-radius: 0 0 50% 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nurse-badge {
            position: absolute;
            top: 22px;
            right: 10px;
            background: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
            color: #5a9fd4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid #4a89c4;
        }

        .nurse-arm {
            position: absolute;
            width: 20px;
            height: 65px;
            background: linear-gradient(135deg, #5a9fd4 0%, #4a89c4 100%);
            border-radius: 10px;
            top: 72px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .nurse-arm-left {
            left: -8px;
            transform: rotate(-18deg);
            animation: armSwingLeft 2.5s ease-in-out infinite;
        }

        .nurse-arm-right {
            right: -8px;
            transform: rotate(18deg);
        }

        @keyframes armSwingLeft {
            0%, 100% { transform: rotate(-18deg); }
            50% { transform: rotate(-25deg); }
        }

        .nurse-legs {
            width: 80px;
            height: 45px;
            margin: 0 auto;
            position: relative;
        }

        .nurse-leg {
            position: absolute;
            top: 0;
            width: 22px;
            height: 45px;
            background: linear-gradient(135deg, #2c5a8e 0%, #1c4a7e 100%);
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .nurse-leg-left { left: 12px; }
        .nurse-leg-right { right: 12px; }

        .nurse-clipboard {
            position: absolute;
            top: 100px;
            right: 12px;
            width: 24px;
            height: 30px;
            background: linear-gradient(135deg, #8b7355 0%, #6b5335 100%);
            border-radius: 3px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            z-index: 11;
        }

        .clipboard-clip {
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 6px;
            background: linear-gradient(135deg, #6b6b6b 0%, #4b4b4b 100%);
            border-radius: 3px 3px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .clipboard-paper {
            position: absolute;
            top: 3px;
            left: 2px;
            width: 20px;
            height: 25px;
            background: white;
            border-radius: 2px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        .clipboard-paper::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 3px;
            right: 3px;
            height: 1px;
            background: #ccc;
            box-shadow: 0 4px 0 #ccc, 0 8px 0 #ccc, 0 12px 0 #ccc;
        }

        .nurse-label {
            margin-top: 178px;
            background: white;
            padding: 10px 18px;
            border-radius: 18px;
            color: #333;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            text-align: center;
            animation: labelFloat 2.5s ease-in-out infinite;
            border: 2px solid #5a9fd4;
        }

        @keyframes labelFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Detailed Patient Figure */
        .patient-figure {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 100px;
            z-index: 5;
        }

        .patient-head {
            position: absolute;
            top: -38px;
            left: 35px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #f5d5b8 0%, #e8c4a8 100%);
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            animation: patientBreathe 3.5s ease-in-out infinite;
            z-index: 10;
        }

        .patient-hair {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 45px;
            height: 25px;
            background: linear-gradient(135deg, #8b6f47 0%, #6b4f27 100%);
            border-radius: 60% 60% 0 0;
        }

        .patient-face {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .patient-eye {
            position: absolute;
            top: 24px;
            width: 20px;
            height: 3px;
            background: #2c3e50;
            border-radius: 50%;
        }

        .patient-eye-closed-left { left: 10px; }
        .patient-eye-closed-right { right: 10px; }

        .patient-body-torso {
            position: absolute;
            top: 15px;
            left: 25px;
            width: 100px;
            height: 60px;
            background: linear-gradient(135deg, #e8d4c0 0%, #d8c4b0 100%);
            border-radius: 15px 15px 8px 8px;
            z-index: 8;
            animation: patientBreathe 3.5s ease-in-out infinite;
        }

        .patient-blanket {
            position: absolute;
            top: 30px;
            left: 20px;
            width: 110px;
            height: 55px;
            background: linear-gradient(135deg, #87ceeb 0%, #6fb3d8 100%);
            border-radius: 10px 10px 20px 20px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,0.3);
            animation: patientBreathe 3.5s ease-in-out infinite;
            z-index: 9;
        }

        .blanket-folds {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 2px;
            background: rgba(255,255,255,0.5);
            border-radius: 2px;
            box-shadow: 0 8px 0 rgba(255,255,255,0.4), 0 16px 0 rgba(255,255,255,0.4), 0 24px 0 rgba(255,255,255,0.3);
        }

        .patient-arm {
            position: absolute;
            width: 18px;
            height: 50px;
            background: linear-gradient(135deg, #f5d5b8 0%, #e8c4a8 100%);
            border-radius: 10px;
            top: 25px;
            z-index: 7;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .patient-arm-left {
            left: 12px;
            transform: rotate(-28deg);
        }

        .patient-arm-right {
            right: 12px;
            transform: rotate(28deg);
        }

        @keyframes patientBreathe {
            0%, 100% { transform: translateX(-50%) scaleY(1); }
            50% { transform: translateX(-50%) scaleY(1.12); }
        }

        /* Enhanced bed */
        .patient-bed {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 170px;
            height: 75px;
            background: linear-gradient(to bottom, #6d4c41 0%, #5d4037 100%);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        .patient-bed::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 6px;
            right: 6px;
            height: 10px;
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            border-radius: 6px 6px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .patient-bed::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 18px;
            width: 12px;
            height: 10px;
            background: linear-gradient(to bottom, #5d4037 0%, #4d3027 100%);
            border-radius: 0 0 5px 5px;
            box-shadow: 130px 0 0 #4d3027;
        }

        /* Enhanced vital monitor */
        .vital-monitor {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 90px;
            height: 70px;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 8px;
            padding: 8px;
            border: 3px solid #16213e;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6), inset 0 2px 4px rgba(255,255,255,0.1);
        }

        .vital-monitor::before {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            animation: monitorPowerBlink 2s ease-in-out infinite;
            box-shadow: 0 0 10px #00ff00, 0 0 20px rgba(0,255,0,0.5);
        }

        @keyframes monitorPowerBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .heartbeat-line {
            width: 100%;
            height: 30px;
            animation: heartbeatPulse 1s ease-in-out infinite;
            stroke: #00ff00;
            stroke-width: 2.5;
            fill: none;
            filter: drop-shadow(0 0 6px #00ff00);
        }

        @keyframes heartbeatPulse {
            0%, 100% { opacity: 1; filter: drop-shadow(0 0 4px #00ff00); }
            10% { opacity: 0.6; filter: drop-shadow(0 0 8px #00ff00); }
            20% { opacity: 1; filter: drop-shadow(0 0 10px #00ff00); }
            30% { opacity: 0.7; filter: drop-shadow(0 0 6px #00ff00); }
        }

        .monitor-text {
            color: #00ff00;
            font-size: 0.8em;
            font-family: 'Courier New', monospace;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 0 6px #00ff00, 0 0 10px rgba(0,255,0,0.5);
            margin-top: 3px;
            animation: monitorTextPulse 1s ease-in-out infinite;
        }

        @keyframes monitorTextPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .vital-monitor {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 80px;
            height: 60px;
            background: #1a1a2e;
            border-radius: 4px;
            padding: 5px;
            border: 2px solid #16213e;
        }

        .heartbeat-line {
            width: 100%;
            height: 30px;
            animation: heartbeat 1.5s ease-in-out infinite;
            stroke: #00ff00;
            stroke-width: 2;
            fill: none;
        }

        @keyframes heartbeat {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .monitor-text {
            color: #00ff00;
            font-size: 0.7em;
            font-family: monospace;
            text-align: center;
        }

        .vignette {
            background: rgba(30, 41, 59, 0.6);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-blue);
        }

        .vignette-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-blue);
        }

        .test-menu {
            margin-top: 20px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .test-card {
            background: var(--bg-medium);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .test-card:hover {
            border-color: var(--primary-blue);
            transform: translateY(-2px);
        }

        .test-card.ordered {
            border-color: var(--success-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .test-card.disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background: var(--bg-dark);
            border-color: var(--danger-red);
        }

        .test-card.disabled:hover {
            transform: none;
            border-color: var(--danger-red);
        }

        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .test-cost {
            color: var(--warning-yellow);
            font-size: 0.9em;
        }

        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: rgba(37, 99, 235, 0.2);
            border-radius: 4px;
            font-size: 0.9em;
        }

        .differential-notepad {
            background: rgba(51, 65, 85, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .notepad-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-blue);
        }

        .diagnosis-item {
            background: var(--bg-medium);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diagnosis-item:hover {
            background: var(--bg-light);
        }

        .diagnosis-item.crossed {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .diagnosis-item.locked {
            background: rgba(37, 99, 235, 0.3);
            border: 2px solid var(--primary-blue);
        }

        .lock-btn {
            padding: 5px 15px;
            background: var(--primary-blue);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
        }

        .lock-btn:hover {
            background: var(--primary-dark);
        }

        .treatment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .treatment-card {
            background: var(--bg-medium);
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .treatment-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.3s;
        }

        .treatment-card:hover::before {
            animation: shimmer 1.5s ease infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .treatment-card:hover {
            border-color: var(--primary-blue);
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .treatment-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .treatment-description {
            font-size: 0.9em;
            color: var(--text-medium);
        }

        .learning-card {
            background: rgba(51, 65, 85, 0.98);
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            margin: 20px auto;
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
        }

        .learning-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--success-green);
            text-align: center;
        }

        .takeaway-section {
            background: rgba(30, 41, 59, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .takeaway-label {
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 5px;
        }

        .efficiency-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .badge-gold {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
        }

        .badge-silver {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #000;
        }

        .badge-bronze {
            background: linear-gradient(135deg, #cd7f32, #d4a574);
            color: #fff;
        }

        .explanation-replay {
            margin-top: 20px;
        }

        .collapsible-header {
            background: var(--bg-medium);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            background: var(--bg-light);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 1000px;
            padding-top: 15px;
        }

        .interpretation-quiz {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid var(--primary-blue);
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .quiz-option {
            background: var(--bg-medium);
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .quiz-option:hover {
            border-color: var(--primary-blue);
        }

        .quiz-option.correct {
            background: rgba(16, 185, 129, 0.3);
            border-color: var(--success-green);
        }

        .quiz-option.incorrect {
            background: rgba(239, 68, 68, 0.3);
            border-color: var(--danger-red);
        }

        .feedback-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .feedback-success {
            background: var(--success-green);
        }

        .feedback-error {
            background: var(--danger-red);
        }

        .feedback-info {
            background: var(--primary-blue);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-dark);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .volume-slider {
            width: 100px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border-width: 0;
        }

        *:focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        .mistake-reminder {
            background: rgba(239, 68, 68, 0.2);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid var(--danger-red);
            font-size: 0.9em;
        }

        .about-panel {
            background: rgba(30, 41, 59, 0.95);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .about-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-blue);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="title">üè• Hospital Hero: Microbiology Mastery</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Day</div>
                    <div class="stat-value" id="dayCounter">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Today</div>
                    <div class="stat-value" id="todayCounter">0/3</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Budget</div>
                    <div class="stat-value" id="score">100</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Cases</div>
                    <div class="stat-value" id="caseCounter">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value" id="streak">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Rating</div>
                    <div class="hospital-rating" id="rating">
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-secondary" onclick="game.toggleAudio()" id="audioBtn">üîä Audio: ON</button>
                <button class="btn btn-secondary" onclick="game.toggleContrast()">üé® High Contrast</button>
                <button class="btn btn-secondary" onclick="game.showAbout()">‚ÑπÔ∏è About</button>
            </div>
        </header>

        <div class="audio-controls" style="margin-bottom: 20px;">
            <label><button class="btn btn-secondary" onclick="game.toggleSFX()" id="sfxBtn">üîä ON</button>
            <label>Volume:</label>
            <input type="range" min="0" max="100" value="50" class="volume-slider" id="volumeSlider" onchange="game.setVolume(this.value)">
        </div>

        <div id="gameContainer"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        // Game object to encapsulate all game logic
        const game = (() => {
            // Game State
            const state = {
                currentCase: null,
                score: 100,
                casesCompleted: 0,
                streak: 0,
                stage: 'diagnosis',
                orderedTests: [],
                crossedDiagnoses: [],
                lockedDiagnosis: null,
                diagnosisCorrect: null,
                physicalExamDone: false,
                showInitialPresentation: false,
                currentDay: 1,
                casesPerDay: 3,
                casesCompletedToday: 0,
                lawsuitsToday: 0,
                mistakesThisCase: 0,
                mistakeMemory: {},
                usedCases: [],
                audioEnabled: true,
                
                sfxEnabled: true,
                volume: 0.5,
            };

            // Audio Context
            let audioContext = null;
            let musicOscillator = null;
            let musicGain = null;

            // Cases Database
            const casesDatabase = [
                {
                    id: 1,
                    initialPresentation: "Triage nurse: 'We have a 19-year-old college student here who's not feeling well. Started recently.'",
                    physicalExam: "Patient appears acutely ill and uncomfortable. Notable photophobia - she winces at the exam light. Nuchal rigidity present. Positive Kernig's sign (pain and resistance when extending knee with hip flexed). Temperature 39.2¬∞C, BP 110/70, HR 108.",
                    correctDiagnosis: "Neisseria meningitidis meningitis",
                    organism: "Neisseria meningitidis",
                    differentials: [
                        "Neisseria meningitidis meningitis",
                        "Pneumococcal pattern meningitis",
                        "Haemophilus influenzae meningitis",
                        "Listeria monocytogenes meningitis",
                        "Viral meningitis",
                        "Brain abscess",
                        "Subarachnoid hemorrhage",
                        "Encephalitis",
                        "Migraine with aura",
                        "Tension headache with fever"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient appears acutely ill and uncomfortable. Notable photophobia - she winces at the exam light. Nuchal rigidity present. Positive Kernig's sign (pain and resistance when extending knee with hip flexed). Temperature 39.2¬∞C, BP 110/70, HR 108.", interpretation: "Signs of meningeal irritation" },
                        { name: "Physical Exam", cost: 0, result: "Patient appears acutely ill and uncomfortable. Notable photophobia - she winces at the exam light. Nuchal rigidity present. Positive Kernig's sign (pain and resistance when extending knee with hip flexed). Temperature 39.2¬∞C, BP 110/70, HR 108.", interpretation: "Signs of meningeal irritation" },
                        { name: "Lumbar Puncture", cost: 70, result: "CSF shows elevated WBCs (>1000), neutrophil predominance, low glucose, elevated protein", interpretation: "Bacterial meningitis pattern" },
                        { name: "Gram Stain", cost: 55, result: "Gram-negative diplococci", interpretation: "Gram-negative diplococci" },
                        { name: "Blood Culture", cost: 60, result: "Positive for gram-negative diplococci", interpretation: "Bacteremia present" },
                        { name: "CBC", cost: 55, result: "Elevated WBC count with left shift", interpretation: "Acute bacterial infection" },
                        { name: "CT Head", cost: 80, result: "No mass lesion or hemorrhage", interpretation: "Rules out space-occupying lesion" },
                        { name: "Throat Culture", cost: 55, result: "Normal flora", interpretation: "Non-contributory" }
                    ],
                    minimumTests: ["Lumbar Puncture", "Gram Stain"],
                    treatments: [
                        { name: "Ceftriaxone", correct: true, explanation: "Third-generation cephalosporin with excellent CSF penetration" },
                        { name: "Ceftriaxone + Vancomycin", correct: false, explanation: "Vancomycin added for broader coverage" },
                        { name: "Penicillin G + Gentamicin", correct: false, explanation: "Combination covers gram-positive and gram-negative" },
                        { name: "Vancomycin + Gentamicin", correct: false, explanation: "Broad spectrum combination" },
                        { name: "Meropenem", correct: false, explanation: "Carbapenem with broad coverage" },
                        { name: "Ciprofloxacin", correct: false, explanation: "Fluoroquinolone alternative" },
                    ],
                    classicClue: "College student in dorm with fever, severe headache, and neck stiffness",
                    keyTest: "CSF with gram-negative diplococci",
                    firstLineTreatment: "Ceftriaxone",
                    whyCorrect: "Neisseria meningitidis is a gram-negative diplococcus that causes bacterial meningitis, especially in young adults in close quarters. CSF shows neutrophil predominance with low glucose.",
                    whyWrong: [
                        "S. pneumoniae would show gram-positive diplococci, not gram-negative",
                        "Viral meningitis would show lymphocyte predominance and normal glucose in CSF"
                    ]
                },
                {
                    id: 2,
                    initialPresentation: "A 45-year-old man with diabetes: 'I haven't been feeling well for a few days now.'",
                    physicalExam: "Patient appears ill. Productive cough noted during exam. Auscultation reveals decreased breath sounds over right lower lobe with crackles. Dullness to percussion in same area. Temperature 38.9¬∞C, O2 sat 92% on room air. Respiratory rate 24.",
                    correctDiagnosis: "Pneumococcal pattern pneumonia",
                    organism: "Pneumococcal pattern",
                    differentials: [
                        "Pneumococcal pattern pneumonia",
                        "Klebsiella pneumoniae pneumonia",
                        "Staphylococcus aureus pneumonia",
                        "Haemophilus influenzae pneumonia",
                        "Mycoplasma pneumonia",
                        "Legionella pneumonia",
                        "Viral pneumonia",
                        "Pulmonary embolism",
                        "Lung cancer",
                        "Tuberculosis"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient appears ill. Productive cough noted during exam. Auscultation reveals decreased breath sounds over right lower lobe with crackles. Dullness to percussion in same area. Temperature 38.9¬∞C, O2 sat 92% on room air. Respiratory rate 24.", interpretation: "Signs of consolidation in right lower lobe" },
                        { name: "Physical Exam", cost: 0, result: "Patient appears ill. Productive cough noted during exam. Auscultation reveals decreased breath sounds over right lower lobe with crackles. Dullness to percussion in same area. Temperature 38.9¬∞C, O2 sat 92% on room air. Respiratory rate 24.", interpretation: "Signs of consolidation in right lower lobe" },
                        { name: "Chest X-ray", cost: 70, result: "Right lower lobe consolidation", interpretation: "Lobar pneumonia pattern" },
                        { name: "Sputum Gram Stain", cost: 55, result: "Gram-positive diplococci", interpretation: "Pneumococcal pattern" },
                        { name: "Blood Culture", cost: 60, result: "Positive for gram-positive diplococci", interpretation: "Bacteremia present" },
                        { name: "CBC", cost: 55, result: "Elevated WBC with neutrophilia", interpretation: "Acute bacterial infection" },
                        { name: "Urinary Antigen Test", cost: 65, result: "Positive for pneumococcal antigen", interpretation: "Confirms pneumococcal infection" },
                        { name: "CT Chest", cost: 80, result: "Lobar consolidation without cavitation", interpretation: "Classic pneumonia" }
                    ],
                    minimumTests: ["Chest X-ray", "Sputum Gram Stain"],
                    treatments: [
                        { name: "Ceftriaxone + Azithromycin", correct: true, explanation: "Covers typical and atypical CAP organisms" },
                        { name: "Levofloxacin", correct: false, explanation: "Respiratory fluoroquinolone monotherapy" },
                        { name: "Amoxicillin-Clavulanate", correct: false, explanation: "Oral beta-lactam option" },
                        { name: "Ceftriaxone + Doxycycline", correct: false, explanation: "Alternative combination" },
                        { name: "Azithromycin", correct: false, explanation: "Macrolide covers atypicals" },
                        { name: "Vancomycin + Azithromycin", correct: false, explanation: "For suspected drug-resistant pneumococcus" },
                    ],
                    classicClue: "Diabetic patient with rust-colored sputum and lobar consolidation on CXR",
                    keyTest: "Gram-positive diplococci on sputum Gram stain",
                    firstLineTreatment: "Ceftriaxone + Azithromycin",
                    whyCorrect: "S. pneumoniae is the most common cause of community-acquired pneumonia, especially in patients with comorbidities. Classic rust-colored sputum and lobar consolidation on imaging.",
                    whyWrong: [
                        "Klebsiella pneumoniae causes currant-jelly sputum and is more common in alcoholics",
                        "Mycoplasma presents with dry cough and walking pneumonia pattern, not lobar consolidation"
                    ]
                },
                {
                    id: 3,
                    initialPresentation: "Obstetrics clinic calls: '28-year-old at 38 weeks gestation here for a routine visit.'",
                    physicalExam: "Patient appears comfortable and healthy. Gravid abdomen consistent with stated gestational age. Fetal heart tones normal. No signs of labor. Vital signs stable and normal for pregnancy.",
                    correctDiagnosis: "Streptococcus agalactiae colonization",
                    organism: "Streptococcus agalactiae",
                    differentials: [
                        "Streptococcus agalactiae colonization",
                        "Escherichia coli colonization",
                        "Candida vaginal colonization",
                        "Normal vaginal flora",
                        "Bacterial vaginosis",
                        "Group A Streptococcus",
                        "Staphylococcus colonization",
                        "Enterococcus colonization",
                        "Lactobacillus overgrowth",
                        "Urinary tract infection"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient appears comfortable and healthy. Gravid abdomen consistent with stated gestational age. Fetal heart tones normal. No signs of labor. Vital signs stable and normal for pregnancy.", interpretation: "Normal pregnancy exam" },
                        { name: "Vaginal/Rectal Culture", cost: 60, result: "Growth of beta-hemolytic bacteria", interpretation: "Beta-hemolytic colonization" },
                        { name: "Gram Stain", cost: 55, result: "Gram-positive cocci in chains", interpretation: "Beta-hemolytic bacteria" },
                        { name: "CAMP Test", cost: 55, result: "Positive", interpretation: "Confirms group B organism" },
                        { name: "Urinalysis", cost: 55, result: "Negative for infection", interpretation: "No UTI" },
                        { name: "CBC", cost: 55, result: "Normal", interpretation: "No systemic infection" },
                        { name: "Hippurate Hydrolysis", cost: 55, result: "Positive", interpretation: "Consistent with group B organism" }
                    ],
                    minimumTests: ["Vaginal/Rectal Culture"],
                    treatments: [
                        { name: "Intrapartum Penicillin G", correct: true, explanation: "Standard IV prophylaxis during labor" },
                        { name: "Cefazolin", correct: false, explanation: "Alternative for mild penicillin allergy" },
                        { name: "Clindamycin", correct: false, explanation: "For severe penicillin allergy if susceptible" },
                        { name: "Ampicillin", correct: false, explanation: "Alternative beta-lactam" },
                        { name: "Vancomycin", correct: false, explanation: "For severe allergy with clindamycin resistance" },
                        { name: "Azithromycin", correct: false, explanation: "Not standard for GBS" },
                    ],
                    classicClue: "Pregnant woman at 35-37 weeks with positive GBS screening culture",
                    keyTest: "Positive vaginal/rectal culture for beta-hemolytic streptococci",
                    firstLineTreatment: "Intrapartum Penicillin G",
                    whyCorrect: "GBS (S. agalactiae) colonizes 10-30% of pregnant women and can cause severe neonatal infections if not treated during labor. Universal screening at 35-37 weeks recommended.",
                    whyWrong: [
                        "E. coli colonization would show gram-negative rods, not gram-positive cocci",
                        "Normal vaginal flora wouldn't include beta-hemolytic streptococci"
                    ]
                },
                {
                    id: 4,
                    initialPresentation: "Mother brings in her 5-year-old: 'He's been sick for a couple days and not acting like himself.'",
                    physicalExam: "Child appears uncomfortable but alert. Pharynx is markedly erythematous with white tonsillar exudates bilaterally. Tender anterior cervical lymph nodes (shotty, mobile). A fine, sandpaper-textured erythematous rash noted on trunk. Temperature 39¬∞C.",
                    correctDiagnosis: "Streptococcus pyogenes pharyngitis (Scarlet Fever)",
                    organism: "Streptococcus pyogenes",
                    differentials: [
                        "Streptococcus pyogenes pharyngitis (Scarlet Fever)",
                        "Viral pharyngitis",
                        "Infectious mononucleosis (EBV)",
                        "Diphtheria",
                        "Peritonsillar abscess",
                        "Kawasaki disease",
                        "Measles",
                        "Candida pharyngitis",
                        "Gonococcal pharyngitis",
                        "Staphylococcal toxic shock syndrome"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Child appears uncomfortable but alert. Pharynx is markedly erythematous with white tonsillar exudates bilaterally. Tender anterior cervical lymph nodes (shotty, mobile). A fine, sandpaper-textured erythematous rash noted on trunk. Temperature 39¬∞C.", interpretation: "Pharyngitis with scarlatiniform rash" },
                        { name: "Rapid Strep Test", cost: 55, result: "Positive", interpretation: "Group A organism present" },
                        { name: "Throat Culture", cost: 55, result: "Growth of beta-hemolytic bacteria", interpretation: "Confirms GAS" },
                        { name: "CBC", cost: 55, result: "Elevated WBC", interpretation: "Bacterial infection" },
                        { name: "ASO Titer", cost: 60, result: "Normal (acute infection)", interpretation: "Too early for antibodies" },
                        { name: "Monospot Test", cost: 55, result: "Negative", interpretation: "Rules out EBV" },
                        { name: "Blood Culture", cost: 60, result: "Negative", interpretation: "No bacteremia" }
                    ],
                    minimumTests: ["Rapid Strep Test"],
                    treatments: [
                        { name: "Penicillin", correct: true, explanation: "First-line for strep pharyngitis" },
                        { name: "Amoxicillin", correct: false, explanation: "Also effective for strep" },
                        { name: "Azithromycin", correct: false, explanation: "Macrolide alternative" },
                        { name: "Cephalexin", correct: false, explanation: "First-generation cephalosporin" },
                        { name: "Clindamycin", correct: false, explanation: "Alternative for penicillin allergy" },
                        { name: "Doxycycline", correct: false, explanation: "Tetracycline with gram-positive coverage" },
                    ],
                    classicClue: "Child with pharyngitis, tonsillar exudates, and sandpaper rash",
                    keyTest: "Positive rapid strep test",
                    firstLineTreatment: "Penicillin V or Amoxicillin",
                    whyCorrect: "S. pyogenes (GAS) causes pharyngitis with classic scarlet fever rash due to erythrogenic toxin. Sandpaper-textured rash is pathognomonic.",
                    whyWrong: [
                        "Viral pharyngitis typically doesn't have tonsillar exudates and wouldn't cause this rash pattern",
                        "EBV causes mononucleosis with fatigue and splenomegaly, not sandpaper rash"
                    ]
                },
                {
                    id: 5,
                    initialPresentation: "65-year-old woman: 'I've been feeling off for a few weeks now. Not quite right.'",
                    physicalExam: "Patient appears chronically ill and fatigued. Cardiac exam reveals a new grade 3/6 systolic murmur at the apex (was not documented in previous visits). Splinter hemorrhages visible under several fingernails. Painless erythematous macules on palms (Janeway lesions). Temperature 38.3¬∞C. No acute distress.",
                    correctDiagnosis: "Viridans streptococci endocarditis",
                    organism: "Viridans streptococci",
                    differentials: [
                        "Viridans streptococci endocarditis",
                        "Staphylococcus aureus endocarditis",
                        "Enterococcus endocarditis",
                        "HACEK organisms endocarditis",
                        "Culture-negative endocarditis",
                        "Acute rheumatic fever",
                        "Atrial myxoma",
                        "Systemic lupus erythematosus",
                        "Vasculitis",
                        "Malignancy"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient appears chronically ill and fatigued. Cardiac exam reveals a new grade 3/6 systolic murmur at the apex (was not documented in previous visits). Splinter hemorrhages visible under several fingernails. Painless erythematous macules on palms (Janeway lesions). Temperature 38.3¬∞C. No acute distress.", interpretation: "New murmur with peripheral stigmata" },
                        { name: "Blood Cultures", cost: 70, result: "Multiple positive for alpha-hemolytic bacteria", interpretation: "Alpha-hemolytic bacteria" },
                        { name: "Echocardiogram", cost: 80, result: "Vegetation on mitral valve", interpretation: "Confirms endocarditis" },
                        { name: "CBC", cost: 55, result: "Anemia, elevated WBC", interpretation: "Chronic infection with inflammation" },
                        { name: "ESR/CRP", cost: 55, result: "Markedly elevated", interpretation: "Active inflammation" },
                        { name: "Urinalysis", cost: 55, result: "RBC casts, hematuria", interpretation: "Glomerulonephritis from immune complexes" },
                        { name: "Chest X-ray", cost: 60, result: "Possible septic emboli", interpretation: "Complications of endocarditis" }
                    ],
                    minimumTests: ["Blood Cultures", "Echocardiogram"],
                    treatments: [
                        { name: "Vancomycin + Gentamicin", correct: true, explanation: "Standard combination for culture-negative endocarditis" },
                        { name: "Ceftriaxone + Gentamicin", correct: false, explanation: "Broad coverage combination" },
                        { name: "Vancomycin + Rifampin", correct: false, explanation: "Alternative combination therapy" },
                        { name: "Nafcillin + Gentamicin", correct: false, explanation: "For MSSA endocarditis" },
                        { name: "Daptomycin", correct: false, explanation: "Alternative for complicated infections" },
                        { name: "Ampicillin + Ceftriaxone", correct: false, explanation: "Combination with enterococcal coverage" },
                    ],
                    classicClue: "Patient with valve disease and recent dental work presenting with fever, new murmur, and Janeway lesions",
                    keyTest: "Multiple positive blood cultures for alpha-hemolytic streptococci + vegetation on echo",
                    firstLineTreatment: "Penicillin G + Gentamicin",
                    whyCorrect: "Viridans streptococci are part of oral flora and cause subacute endocarditis especially after dental procedures in patients with valve abnormalities. Classic Osler nodes and Janeway lesions.",
                    whyWrong: [
                        "S. aureus endocarditis is more acute and aggressive, typically in IV drug users",
                        "Culture-negative endocarditis would not have positive blood cultures"
                    ]
                },
                {
                    id: 6,
                    initialPresentation: "Nurse pages you: '55-year-old diabetic post-op from foot surgery 2 days ago, not doing well.'",
                    physicalExam: "Patient appears toxic and in severe distress. Left lower leg shows rapidly spreading erythema with dusky, discolored areas. Multiple hemorrhagic bullae present. Palpation reveals crepitus in affected area. Skin is tense and exquisitely tender. Temperature 39.5¬∞C, BP 82/48, HR 128. Patient is diaphoretic.",
                    correctDiagnosis: "Staphylococcus aureus necrotizing fasciitis",
                    organism: "Staphylococcus aureus",
                    differentials: [
                        "Staphylococcus aureus necrotizing fasciitis",
                        "Streptococcus pyogenes necrotizing fasciitis",
                        "Clostridium perfringens gas gangrene",
                        "Severe cellulitis",
                        "Deep vein thrombosis",
                        "Compartment syndrome",
                        "Diabetic foot infection",
                        "Pyomyositis",
                        "Osteomyelitis",
                        "Septic shock from other source"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient appears toxic and in severe distress. Left lower leg shows rapidly spreading erythema with dusky, discolored areas. Multiple hemorrhagic bullae present. Palpation reveals crepitus in affected area. Skin is tense and exquisitely tender. Temperature 39.5¬∞C, BP 82/48, HR 128. Patient is diaphoretic.", interpretation: "Necrotizing soft tissue infection" },
                        { name: "Surgical Exploration", cost: 50, result: "Necrotic fascia, dishwater fluid", interpretation: "Necrotizing soft tissue infection" },
                        { name: "Gram Stain", cost: 55, result: "Gram-positive cocci in clusters", interpretation: "Cocci in clusters" },
                        { name: "Blood Culture", cost: 60, result: "Positive for methicillin-resistant organism", interpretation: "Bacteremia with resistant organism" },
                        { name: "X-ray", cost: 60, result: "Gas in soft tissues", interpretation: "Suggests gas-forming infection" },
                        { name: "CBC", cost: 55, result: "Severe leukocytosis, left shift", interpretation: "Overwhelming infection" },
                        { name: "Lactate", cost: 55, result: "Elevated", interpretation: "Tissue hypoperfusion, sepsis" },
                        { name: "CT Scan", cost: 80, result: "Fascial plane involvement, gas tracking", interpretation: "Confirms necrotizing fasciitis" }
                    ],
                    minimumTests: ["Surgical Exploration", "Gram Stain", "Blood Culture"],
                    treatments: [
                        { name: "Clindamycin + Surgical debridement", correct: true, explanation: "Clindamycin stops toxin production plus urgent surgery" },
                        { name: "Penicillin + Clindamycin", correct: false, explanation: "Combination therapy approach" },
                        { name: "Vancomycin + Piperacillin-Tazobactam", correct: false, explanation: "Broad empiric coverage" },
                        { name: "Ceftriaxone + Metronidazole", correct: false, explanation: "Covers aerobic and anaerobic organisms" },
                        { name: "Linezolid", correct: false, explanation: "Anti-MRSA coverage" },
                        { name: "Daptomycin + Clindamycin", correct: false, explanation: "Alternative combination" },
                    ],
                    classicClue: "Post-surgical diabetic with rapidly spreading cellulitis, bullae, crepitus, and hypotension",
                    keyTest: "Surgical exploration showing necrotic fascia + Gram-positive cocci in clusters",
                    firstLineTreatment: "Emergency surgical debridement + Vancomycin + Piperacillin-Tazobactam",
                    whyCorrect: "Necrotizing fasciitis is a surgical emergency. Post-op infection with pain out of proportion, systemic toxicity, and crepitus. S. aureus (especially MRSA) common in post-surgical infections.",
                    whyWrong: [
                        "GAS (S. pyogenes) necrotizing fasciitis shows gram-positive cocci in chains, not clusters",
                        "Simple cellulitis wouldn't have crepitus, necrotic fascia, or progress this rapidly"
                    ]
                },
                {
                    id: 7,
                    initialPresentation: "Worried parents with their 3-week-old: 'She doesn't seem right. Not eating well.'",
                    physicalExam: "Infant appears lethargic with weak cry. Anterior fontanelle is full and slightly bulging. Nuchal rigidity difficult to assess but some resistance to neck flexion noted. Skin is mottled. Temperature 38.8¬∞C rectally. Irritable when handled.",
                    correctDiagnosis: "Listeria monocytogenes meningitis",
                    organism: "Listeria monocytogenes",
                    differentials: [
                        "Listeria monocytogenes meningitis",
                        "E. coli meningitis",
                        "Group B Streptococcus meningitis",
                        "Neonatal sepsis",
                        "Viral meningitis",
                        "Metabolic disorder",
                        "Congenital infection",
                        "Hypoglycemia",
                        "Inborn error of metabolism",
                        "Cerebral hemorrhage"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Infant appears lethargic with weak cry. Anterior fontanelle is full and slightly bulging. Nuchal rigidity difficult to assess but some resistance to neck flexion noted. Skin is mottled. Temperature 38.8¬∞C rectally. Irritable when handled.", interpretation: "Signs of meningitis in neonate" },
                        { name: "Lumbar Puncture", cost: 70, result: "Elevated WBC, protein elevated, low glucose", interpretation: "Bacterial meningitis" },
                        { name: "CSF Gram Stain", cost: 55, result: "Gram-positive rods", interpretation: "Motile gram-positive rod likely" },
                        { name: "CSF Culture", cost: 60, result: "Growth shows tumbling motility at room temp", interpretation: "Confirms motile gram-positive rod" },
                        { name: "Blood Culture", cost: 60, result: "Positive for motile gram-positive rod", interpretation: "Bacteremia present" },
                        { name: "CBC", cost: 55, result: "Leukocytosis", interpretation: "Bacterial infection" },
                        { name: "Blood Glucose", cost: 50, result: "Normal", interpretation: "Rules out hypoglycemia" }
                    ],
                    minimumTests: ["Lumbar Puncture", "CSF Gram Stain"],
                    treatments: [
                        { name: "Ampicillin + Gentamicin", correct: true, explanation: "Synergistic combination for neonatal Listeria" },
                        { name: "Ceftriaxone", correct: false, explanation: "Not effective against Listeria" },
                        { name: "Vancomycin + Gentamicin", correct: false, explanation: "Alternative for sepsis coverage" },
                        { name: "Ampicillin", correct: false, explanation: "Needs aminoglycoside for synergy" },
                        { name: "Penicillin G + Gentamicin", correct: false, explanation: "Ampicillin preferred over penicillin" },
                        { name: "Meropenem", correct: false, explanation: "Broad carbapenem coverage" },
                    ],
                    classicClue: "Neonate with meningitis, maternal history of deli meat consumption, gram-positive rods with tumbling motility",
                    keyTest: "CSF with gram-positive rods showing tumbling motility",
                    firstLineTreatment: "Ampicillin + Gentamicin",
                    whyCorrect: "Listeria causes neonatal meningitis via vertical transmission. Tumbling motility at room temperature is pathognomonic. Grows on cold enrichment. Cephalosporins CANNOT treat Listeria.",
                    whyWrong: [
                        "E. coli meningitis shows gram-negative rods, not gram-positive",
                        "GBS meningitis shows gram-positive cocci in chains, not rods"
                    ]
                },
                {
                    id: 8,
                    initialPresentation: "25-year-old woman: 'I've been having some discomfort. Started yesterday.'",
                    physicalExam: "Patient appears comfortable but mildly uncomfortable. Abdomen is soft with suprapubic tenderness on palpation. No costovertebral angle tenderness. No fever. Vital signs normal. No vaginal discharge noted.",
                    correctDiagnosis: "Escherichia coli urinary tract infection",
                    organism: "Escherichia coli",
                    differentials: [
                        "Escherichia coli urinary tract infection",
                        "Klebsiella UTI",
                        "Proteus mirabilis UTI",
                        "Staphylococcus saprophyticus UTI",
                        "Enterococcus UTI",
                        "Sexually transmitted infection",
                        "Interstitial cystitis",
                        "Urethritis",
                        "Vaginitis",
                        "Pelvic inflammatory disease"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient appears comfortable but mildly uncomfortable. Abdomen is soft with suprapubic tenderness on palpation. No costovertebral angle tenderness. No fever. Vital signs normal. No vaginal discharge noted.", interpretation: "Suprapubic tenderness, no systemic signs" },
                        { name: "Urinalysis", cost: 55, result: "WBCs, bacteria, positive nitrites, leukocyte esterase positive", interpretation: "Bacterial UTI" },
                        { name: "Urine Culture", cost: 60, result: "Growth of >100,000 CFU/mL lactose-fermenting gram-negative rod", interpretation: "Confirms lactose-fermenting organism" },
                        { name: "Gram Stain", cost: 55, result: "Gram-negative rods", interpretation: "Enterobacteriaceae" },
                        { name: "CBC", cost: 55, result: "Normal", interpretation: "No systemic infection" },
                        { name: "Pregnancy Test", cost: 55, result: "Negative", interpretation: "Not pregnant" },
                        { name: "STI Panel", cost: 70, result: "Negative", interpretation: "Rules out STI" }
                    ],
                    minimumTests: ["Urinalysis"],
                    treatments: [
                        { name: "Nitrofurantoin or TMP-SMX", correct: true, explanation: "First-line oral options for uncomplicated UTI" },
                        { name: "Ciprofloxacin", correct: false, explanation: "Fluoroquinolone reserved for complicated cases" },
                        { name: "Cephalexin", correct: false, explanation: "Alternative oral option" },
                        { name: "Amoxicillin-Clavulanate", correct: false, explanation: "Broader coverage than needed" },
                        { name: "Fosfomycin", correct: false, explanation: "Single-dose alternative" },
                        { name: "Ceftriaxone", correct: false, explanation: "Parenteral option for complicated cases" },
                    ],
                    classicClue: "Young woman with dysuria, frequency, and positive nitrites on UA",
                    keyTest: "Urinalysis with WBCs, bacteria, and positive nitrites",
                    firstLineTreatment: "Nitrofurantoin or TMP-SMX",
                    whyCorrect: "E. coli causes 80-90% of uncomplicated UTIs in young women. Positive nitrites indicate bacteria that reduce nitrate to nitrite (E. coli does this).",
                    whyWrong: [
                        "S. saprophyticus is second most common but less likely with positive nitrites",
                        "STI would present with discharge and wouldn't show bacteria on UA"
                    ]
                },
                {
                    id: 9,
                    initialPresentation: "55-year-old man: 'I got really sick yesterday. Feeling terrible.'",
                    physicalExam: "Patient appears acutely ill and toxic. Productive cough with thick, bloody, gelatinous sputum (currant-jelly appearance). Decreased breath sounds over right upper lobe with bronchial breath sounds and egophony. Dullness to percussion. Temperature 39.8¬∞C, O2 sat 88% on room air. Signs of chronic alcohol use.",
                    correctDiagnosis: "Klebsiella pneumoniae pneumonia",
                    organism: "Klebsiella pneumoniae",
                    differentials: [
                        "Klebsiella pneumoniae pneumonia",
                        "Pneumococcal pattern pneumonia",
                        "Staphylococcus aureus pneumonia",
                        "Aspiration pneumonia",
                        "Lung abscess",
                        "Tuberculosis",
                        "Pulmonary embolism",
                        "Lung cancer",
                        "Pneumocystis pneumonia",
                        "Fungal pneumonia"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient appears acutely ill and toxic. Productive cough with thick, bloody, gelatinous sputum (currant-jelly appearance). Decreased breath sounds over right upper lobe with bronchial breath sounds and egophony. Dullness to percussion. Temperature 39.8¬∞C, O2 sat 88% on room air. Signs of chronic alcohol use.", interpretation: "Severe pneumonia with characteristic sputum" },
                        { name: "Chest X-ray", cost: 70, result: "Right upper lobe consolidation with bulging fissure", interpretation: "Encapsulated organism pneumonia pattern" },
                        { name: "Sputum Gram Stain", cost: 55, result: "Gram-negative rods with thick capsule", interpretation: "Encapsulated gram-negative organism" },
                        { name: "Sputum Culture", cost: 60, result: "Encapsulated gram-negative rod, mucoid colonies", interpretation: "Confirms encapsulated gram-negative rod" },
                        { name: "Blood Culture", cost: 60, result: "Positive for encapsulated gram-negative rod", interpretation: "Bacteremia present" },
                        { name: "CBC", cost: 55, result: "Marked leukocytosis", interpretation: "Severe infection" },
                        { name: "ABG", cost: 60, result: "Hypoxemia", interpretation: "Respiratory compromise" }
                    ],
                    minimumTests: ["Chest X-ray", "Sputum Gram Stain"],
                    treatments: [
                        { name: "Ceftriaxone", correct: true, explanation: "Third-generation cephalosporin for gram-negative coverage" },
                        { name: "Cefepime", correct: false, explanation: "Fourth-generation with broader coverage" },
                        { name: "Piperacillin-Tazobactam", correct: false, explanation: "Broader spectrum antipseudomonal" },
                        { name: "Meropenem", correct: false, explanation: "Carbapenem for resistant organisms" },
                        { name: "Ciprofloxacin + Gentamicin", correct: false, explanation: "Double gram-negative coverage" },
                        { name: "Aztreonam", correct: false, explanation: "Monobactam alternative" },
                    ],
                    classicClue: "Alcoholic with currant-jelly sputum and bulging fissure sign on CXR",
                    keyTest: "Sputum showing gram-negative rods with thick capsule",
                    firstLineTreatment: "Ceftriaxone or Fluoroquinolone",
                    whyCorrect: "Klebsiella pneumoniae causes pneumonia in alcoholics and diabetics. Pathognomonic currant-jelly sputum (bloody, mucoid) and bulging fissure from voluminous inflammatory exudate.",
                    whyWrong: [
                        "S. pneumoniae causes rust-colored sputum, not currant-jelly",
                        "Aspiration pneumonia typically involves right lower lobe, not upper"
                    ]
                },
                {
                    id: 10,
                    initialPresentation: "Nursing home calls about 70-year-old with chronic catheter: 'He's different today, not himself.'",
                    physicalExam: "Patient is oriented to person only, confused about place and time. Chronic indwelling Foley catheter in place with cloudy, foul-smelling urine visible in collection bag. Strong ammonia odor. Suprapubic tenderness present. Temperature 37.8¬∞C. No focal neurological deficits.",
                    correctDiagnosis: "Proteus mirabilis urinary tract infection",
                    organism: "Proteus mirabilis",
                    differentials: [
                        "Proteus mirabilis urinary tract infection",
                        "E. coli UTI",
                        "Klebsiella UTI",
                        "Pseudomonas UTI",
                        "Enterococcus UTI",
                        "Staphylococcus UTI",
                        "Urinary retention",
                        "Bladder stone",
                        "Urosepsis",
                        "Acute delirium from other cause"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient is oriented to person only, confused about place and time. Chronic indwelling Foley catheter in place with cloudy, foul-smelling urine visible in collection bag. Strong ammonia odor. Suprapubic tenderness present. Temperature 37.8¬∞C. No focal neurological deficits.", interpretation: "Altered mental status with catheter-associated UTI" },
                        { name: "Urinalysis", cost: 55, result: "Alkaline pH 8.5, struvite crystals, WBCs, bacteria", interpretation: "Urease-producing organism" },
                        { name: "Urine Culture", cost: 60, result: "Swarming growth on agar", interpretation: "Confirms urease-producing organism" },
                        { name: "Gram Stain", cost: 55, result: "Gram-negative rods", interpretation: "Enterobacteriaceae" },
                        { name: "Blood Culture", cost: 60, result: "Negative", interpretation: "No bacteremia" },
                        { name: "CT Abdomen", cost: 80, result: "Staghorn calculus in right kidney", interpretation: "Complication of chronic infection" },
                        { name: "BUN/Creatinine", cost: 55, result: "Elevated", interpretation: "Renal dysfunction" }
                    ],
                    minimumTests: ["Urinalysis", "Urine Culture"],
                    treatments: [
                        { name: "Ceftriaxone or Ciprofloxacin", correct: true, explanation: "For complicated catheter-associated UTI" },
                        { name: "Nitrofurantoin", correct: false, explanation: "Not effective for Proteus" },
                        { name: "TMP-SMX", correct: false, explanation: "Reasonable alternative if susceptible" },
                        { name: "Cephalexin", correct: false, explanation: "First-generation option" },
                        { name: "Amoxicillin-Clavulanate", correct: false, explanation: "Oral beta-lactam" },
                        { name: "Levofloxacin", correct: false, explanation: "Alternative fluoroquinolone" },
                    ],
                    classicClue: "Nursing home patient with Foley, alkaline urine with struvite crystals and ammonia odor",
                    keyTest: "Alkaline urine pH >8 with struvite crystals",
                    firstLineTreatment: "Ceftriaxone or Fluoroquinolone",
                    whyCorrect: "Proteus mirabilis is urease-positive, splitting urea into ammonia (causing alkaline pH and ammonia smell). Leads to struvite stones (staghorn calculi). Swarming motility on agar.",
                    whyWrong: [
                        "E. coli doesn't produce urease and wouldn't cause alkaline urine or struvite stones",
                        "Enterococcus wouldn't cause characteristic swarming growth pattern"
                    ]
                },
                {
                    id: 11,
                    initialPresentation: "18-year-old comes in: 'I'm not feeling great. This has been going on a bit.'",
                    physicalExam: "Patient appears uncomfortable and mildly dehydrated. Abdomen is diffusely tender, especially in lower quadrants. Active bowel sounds. No peritoneal signs. Temperature 38.5¬∞C. Mucous membranes slightly dry.",
                    correctDiagnosis: "Shigella dysentery",
                    organism: "Shigella",
                    differentials: [
                        "Shigella dysentery",
                        "Salmonella gastroenteritis",
                        "E. coli (EHEC/EIEC)",
                        "Campylobacter jejuni",
                        "Entamoeba histolytica",
                        "Inflammatory bowel disease",
                        "C. difficile colitis",
                        "Ischemic colitis",
                        "Yersinia enterocolitica",
                        "Viral gastroenteritis"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient appears uncomfortable and mildly dehydrated. Abdomen is diffusely tender, especially in lower quadrants. Active bowel sounds. No peritoneal signs. Temperature 38.5¬∞C. Mucous membranes slightly dry.", interpretation: "Acute enterocolitis with dehydration" },
                        { name: "Stool Culture", cost: 60, result: "Non-lactose fermenting, non-motile gram-negative rods", interpretation: "Invasive organism pattern" },
                        { name: "Gram Stain", cost: 55, result: "Gram-negative rods, numerous WBCs", interpretation: "Invasive bacterial diarrhea" },
                        { name: "Stool Microscopy", cost: 55, result: "Abundant PMNs, RBCs", interpretation: "Inflammatory/invasive diarrhea" },
                        { name: "CBC", cost: 55, result: "Leukocytosis", interpretation: "Bacterial infection" },
                        { name: "Stool O&P", cost: 60, result: "Negative", interpretation: "No parasites" },
                        { name: "Blood Culture", cost: 60, result: "Negative", interpretation: "No bacteremia" }
                    ],
                    minimumTests: ["Stool Culture", "Stool Microscopy"],
                    treatments: [
                        { name: "Nafcillin or Cefazolin", correct: true, explanation: "First-line for MSSA infections" },
                        { name: "Vancomycin", correct: false, explanation: "Reserved for MRSA" },
                        { name: "Ceftriaxone", correct: false, explanation: "Third-generation with some staph coverage" },
                        { name: "Daptomycin", correct: false, explanation: "Alternative for complicated infections" },
                        { name: "Linezolid", correct: false, explanation: "For MRSA coverage" },
                        { name: "Cefazolin + Gentamicin", correct: false, explanation: "Combination approach" },
                    ],
                    classicClue: "Traveler's diarrhea with bloody stools, fever, and non-motile non-lactose fermenter",
                    keyTest: "Stool culture showing non-motile gram-negative rods with abundant fecal WBCs",
                    firstLineTreatment: "Ciprofloxacin or Azithromycin",
                    whyCorrect: "Shigella causes dysentery (bloody diarrhea) with very low infectious dose (10-100 organisms). Non-motile distinguishes from Salmonella. Invades colonic mucosa causing inflammatory diarrhea.",
                    whyWrong: [
                        "Salmonella is motile and typically causes bacteremia (Shigella rarely does)",
                        "Campylobacter is curved/spiral rods, not straight rods"
                    ]
                },
                {
                    id: 12,
                    initialPresentation: "32-year-old landscaper: 'I've been sick for about a week.'",
                    physicalExam: "Patient is thin, appears chronically ill. Multiple track marks visible on both arms. Cardiac exam reveals a new holosystolic murmur heard best at left lower sternal border, increases with inspiration (tricuspid regurgitation). Lungs have scattered crackles. Temperature 38.9¬∞C, O2 sat 93%. Tachycardic.",
                    correctDiagnosis: "Staphylococcus aureus tricuspid endocarditis with septic emboli",
                    organism: "Staphylococcus aureus",
                    differentials: [
                        "Staphylococcus aureus tricuspid endocarditis with septic emboli",
                        "Tuberculosis",
                        "Fungal pneumonia",
                        "Septic pulmonary emboli from other source",
                        "Pneumonia with empyema",
                        "Lung abscess",
                        "Wegener's granulomatosis",
                        "Metastatic cancer",
                        "Pneumocystis jirovecii pneumonia",
                        "Bacterial pneumonia"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient is thin, appears chronically ill. Multiple track marks visible on both arms. Cardiac exam reveals a new holosystolic murmur heard best at left lower sternal border, increases with inspiration (tricuspid regurgitation). Lungs have scattered crackles. Temperature 38.9¬∞C, O2 sat 93%. Tachycardic.", interpretation: "IV drug use with new TR murmur" },
                        { name: "Blood Cultures", cost: 70, result: "Multiple positive for resistant organism", interpretation: "Coagulase-positive bacteremia" },
                        { name: "Echocardiogram", cost: 80, result: "Vegetation on tricuspid valve", interpretation: "Right-sided endocarditis" },
                        { name: "Chest X-ray", cost: 70, result: "Multiple peripheral cavitary nodules", interpretation: "Septic pulmonary emboli" },
                        { name: "CBC", cost: 55, result: "Leukocytosis", interpretation: "Infection" },
                        { name: "HIV Test", cost: 60, result: "May be positive or negative", interpretation: "Risk assessment for IVDU" },
                        { name: "CT Chest", cost: 80, result: "Multiple cavitating lesions feeding vessels", interpretation: "Confirms septic emboli" }
                    ],
                    minimumTests: ["Blood Cultures", "Echocardiogram", "Chest X-ray"],
                    treatments: [
                        { name: "Ciprofloxacin or Azithromycin", correct: true, explanation: "First-line for dysentery" },
                        { name: "Ceftriaxone", correct: false, explanation: "Alternative for resistance" },
                        { name: "TMP-SMX", correct: false, explanation: "Historical choice now with resistance" },
                        { name: "Levofloxacin", correct: false, explanation: "Alternative fluoroquinolone" },
                        { name: "Azithromycin + Ciprofloxacin", correct: false, explanation: "Combination not needed" },
                        { name: "Metronidazole", correct: false, explanation: "Not effective for Shigella" },
                    ],
                    classicClue: "IV drug user with fever, new TR murmur, and cavitary lung lesions",
                    keyTest: "Multiple positive blood cultures + tricuspid vegetation + cavitary lung lesions",
                    firstLineTreatment: "Vancomycin (if MRSA) or Nafcillin (if MSSA)",
                    whyCorrect: "IV drug users get right-sided endocarditis from S. aureus injected directly into veins. Tricuspid vegetations embolize to lungs causing cavitary lesions. MRSA common in IVDU.",
                    whyWrong: [
                        "TB would show apical disease, not multiple peripheral cavitary lesions with feeding vessels",
                        "Pneumocystis presents with diffuse infiltrates, not discrete cavitary lesions"
                    ]
                },
                {
                    id: 13,
                    initialPresentation: "22-year-old recent immigrant: 'I haven't been well for a while now.'",
                    physicalExam: "Patient walks with significant limp. Hip is warm to touch with mild erythema. Pain with range of motion, especially internal rotation. No obvious wound dehiscence. Temperature 38.2¬∞C. Mild tenderness over hip joint.",
                    correctDiagnosis: "Staphylococcus epidermidis prosthetic joint infection",
                    organism: "Staphylococcus epidermidis",
                    differentials: [
                        "Staphylococcus epidermidis prosthetic joint infection",
                        "Staphylococcus aureus prosthetic joint infection",
                        "Streptococcus prosthetic joint infection",
                        "Culture contamination",
                        "Prosthetic loosening (non-infectious)",
                        "Gout",
                        "Pseudogout",
                        "Fracture",
                        "Dislocation",
                        "Heterotopic ossification"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient walks with significant limp. Hip is warm to touch with mild erythema. Pain with range of motion, especially internal rotation. No obvious wound dehiscence. Temperature 38.2¬∞C. Mild tenderness over hip joint.", interpretation: "Prosthetic joint with signs of infection" },
                        { name: "Joint Aspirate Culture", cost: 70, result: "Coagulase-negative cocci, biofilm producer", interpretation: "S. epidermidis infection" },
                        { name: "Gram Stain", cost: 55, result: "Gram-positive cocci in clusters", interpretation: "Cocci in clusters" },
                        { name: "Synovial Fluid Analysis", cost: 60, result: "Elevated WBC with PMN predominance", interpretation: "Septic joint" },
                        { name: "Blood Culture", cost: 60, result: "Negative", interpretation: "Localized infection" },
                        { name: "X-ray", cost: 60, result: "Prosthetic in place, possible loosening", interpretation: "Chronic infection changes" },
                        { name: "ESR/CRP", cost: 55, result: "Elevated", interpretation: "Inflammation/infection" }
                    ],
                    minimumTests: ["Joint Aspirate Culture", "Gram Stain"],
                    treatments: [
                        { name: "RIPE therapy (Rifampin, Isoniazid, Pyrazinamide, Ethambutol)", correct: true, explanation: "Standard four-drug regimen for 6 months" },
                        { name: "Isoniazid + Rifampin", correct: false, explanation: "Insufficient coverage initially" },
                        { name: "Rifampin + Ethambutol", correct: false, explanation: "Missing key drugs" },
                        { name: "Levofloxacin + Isoniazid", correct: false, explanation: "For drug-resistant TB" },
                        { name: "Isoniazid + Rifampin + Pyrazinamide", correct: false, explanation: "Missing ethambutol" },
                        { name: "Moxifloxacin + Linezolid", correct: false, explanation: "For extensively drug-resistant TB" },
                    ],
                    classicClue: "Prosthetic joint infection months after surgery with coagulase-negative staph",
                    keyTest: "Joint aspirate showing gram-positive cocci in clusters, coagulase-negative",
                    firstLineTreatment: "Vancomycin + Rifampin with prosthesis removal",
                    whyCorrect: "S. epidermidis is part of skin flora and causes prosthetic infections via biofilm formation. Coagulase-negative distinguishes from S. aureus. Biofilm prevents antibiotic penetration.",
                    whyWrong: [
                        "S. aureus would be coagulase-positive and typically more acute presentation",
                        "Simple contamination wouldn't have clinical signs of infection or elevated synovial WBCs"
                    ]
                },
                {
                    id: 14,
                    initialPresentation: "45-year-old returns from Middle East trip: 'I got sick while traveling.'",
                    physicalExam: "STOP - Do NOT examine the throat! Child is in tripod position (sitting up, leaning forward, chin up). Audible inspiratory stridor. Drooling profusely. Appears toxic and in respiratory distress. Temperature 39.8¬∞C. Using accessory muscles to breathe. Refusing to speak or swallow.",
                    correctDiagnosis: "Haemophilus influenzae type b epiglottitis",
                    organism: "Haemophilus influenzae",
                    differentials: [
                        "Haemophilus influenzae type b epiglottitis",
                        "Croup (viral laryngotracheobronchitis)",
                        "Bacterial tracheitis",
                        "Peritonsillar abscess",
                        "Retropharyngeal abscess",
                        "Foreign body aspiration",
                        "Angioedema",
                        "Diphtheria",
                        "Severe tonsillitis",
                        "Laryngospasm"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "STOP - Do NOT examine the throat! Child is in tripod position (sitting up, leaning forward, chin up). Audible inspiratory stridor. Drooling profusely. Appears toxic and in respiratory distress. Temperature 39.8¬∞C. Using accessory muscles to breathe. Refusing to speak or swallow.", interpretation: "Signs of severe airway obstruction - EMERGENCY" },
                        { name: "Lateral Neck X-ray", cost: 60, result: "Thumb sign (swollen epiglottis)", interpretation: "Epiglottitis" },
                        { name: "Blood Culture", cost: 60, result: "Gram-negative coccobacilli, requires factors V and X", interpretation: "H. influenzae type b" },
                        { name: "CBC", cost: 55, result: "Marked leukocytosis", interpretation: "Severe bacterial infection" },
                        { name: "Laryngoscopy", cost: 80, result: "Cherry-red swollen epiglottis", interpretation: "Confirms epiglottitis (DO NOT do unless intubation ready!)" },
                        { name: "Pulse Oximetry", cost: 50, result: "Hypoxemia", interpretation: "Airway obstruction" },
                        { name: "ABG", cost: 60, result: "Hypoxia, respiratory acidosis", interpretation: "Impending respiratory failure" }
                    ],
                    minimumTests: ["Lateral Neck X-ray", "Blood Culture"],
                    treatments: [
                        { name: "Doxycycline + Rifampin", correct: true, explanation: "Standard 6-week combination therapy" },
                        { name: "Doxycycline + Gentamicin", correct: false, explanation: "Alternative combination" },
                        { name: "Ciprofloxacin + Rifampin", correct: false, explanation: "Fluoroquinolone-based regimen" },
                        { name: "Azithromycin", correct: false, explanation: "Macrolide monotherapy" },
                        { name: "TMP-SMX + Doxycycline", correct: false, explanation: "Alternative combination" },
                        { name: "Streptomycin + Doxycycline", correct: false, explanation: "Historical regimen" },
                    ],
                    classicClue: "Unvaccinated child with 4 Ds: Drooling, Dysphagia, Distressed, Dyspnea in tripod position",
                    keyTest: "Lateral neck X-ray showing thumb sign",
                    firstLineTreatment: "Emergent airway management + Ceftriaxone",
                    whyCorrect: "H. influenzae type b causes epiglottitis (rare now due to vaccination). Medical emergency with rapid progression. Thumb sign on X-ray. Never examine throat - can trigger complete obstruction.",
                    whyWrong: [
                        "Croup presents with barking cough and steeple sign on X-ray, not thumb sign",
                        "Foreign body would have sudden onset, not progressive fever and toxicity"
                    ]
                },
                {
                    id: 15,
                    initialPresentation: "28-year-old with cystic fibrosis: 'I've been feeling worse than usual lately.'",
                    physicalExam: "Patient in mild respiratory distress. Productive cough with thick green sputum noted during exam. Bilateral crackles and wheezes throughout lung fields. Clubbing of digits. Barrel chest deformity. Temperature 38.1¬∞C. O2 sat 91% on room air. Prolonged expiratory phase.",
                    correctDiagnosis: "Oxidase-positive organism pneumonia",
                    organism: "Oxidase-positive organism",
                    differentials: [
                        "Oxidase-positive organism pneumonia",
                        "Burkholderia cepacia pneumonia",
                        "Stenotrophomonas maltophilia",
                        "Achromobacter pneumonia",
                        "Bacterial exacerbation from other organism",
                        "Aspergillus colonization/ABPA",
                        "Mycobacterium abscessus",
                        "Pulmonary embolism",
                        "Pneumothorax",
                        "Hemoptysis from other cause"
                    ],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Patient in mild respiratory distress. Productive cough with thick green sputum noted during exam. Bilateral crackles and wheezes throughout lung fields. Clubbing of digits. Barrel chest deformity. Temperature 38.1¬∞C. O2 sat 91% on room air. Prolonged expiratory phase.", interpretation: "CF exacerbation with respiratory distress" },
                        { name: "Sputum Culture", cost: 60, result: "Oxidase-positive, blue-green pigment, grape odor", interpretation: "Oxidase-positive organism" },
                        { name: "Gram Stain", cost: 55, result: "Gram-negative rods", interpretation: "Oxidase-positive rod likely" },
                        { name: "Chest X-ray", cost: 70, result: "Bronchiectasis, new infiltrate", interpretation: "CF with acute exacerbation" },
                        { name: "Blood Culture", cost: 60, result: "May be positive in severe cases", interpretation: "Assess for bacteremia" },
                        { name: "CBC", cost: 55, result: "Leukocytosis", interpretation: "Infection" },
                        { name: "Pulmonary Function Tests", cost: 65, result: "Decreased FEV1", interpretation: "Acute worsening" }
                    ],
                    minimumTests: ["Sputum Culture", "Gram Stain"],
                    treatments: [
                        { name: "Antipseudomonal beta-lactam + Aminoglycoside", correct: true, explanation: "Combination prevents resistance" },
                        { name: "Cefepime + Ciprofloxacin", correct: false, explanation: "Alternative antipseudomonal combination" },
                        { name: "Piperacillin-Tazobactam + Tobramycin", correct: false, explanation: "Another valid combination approach" },
                        { name: "Meropenem", correct: false, explanation: "Carbapenem for resistant strains" },
                        { name: "Aztreonam + Levofloxacin", correct: false, explanation: "Double coverage approach" },
                        { name: "Ceftazidime", correct: false, explanation: "Antipseudomonal cephalosporin" },
                    ],
                    classicClue: "CF patient with green sputum, oxidase-positive organism with blue-green pigment and grape odor",
                    keyTest: "Sputum culture with oxidase-positive, pyocyanin (blue-green) pigment production",
                    firstLineTreatment: "Antipseudomonal beta-lactam + Aminoglycoside",
                    whyCorrect: "Oxidase-positive organism chronically colonizes CF patients. Produces pyocyanin (blue-green pigment) and pyoverdin. Grape-like odor. Oxidase-positive. Requires combination therapy to prevent resistance.",
                    whyWrong: [
                        "Burkholderia cepacia is oxidase-positive but doesn't produce characteristic blue-green pigment",
                        "Aspergillus would show fungal elements on microscopy, not gram-negative rods"
                    ]
                },
                {
                    id: 16,
                    initialPresentation: "35-year-old after camping trip: 'I haven't felt right since I got back from camping.'",
                    physicalExam: "Mildly dehydrated, diffusely tender abdomen, hyperactive bowel sounds. Temp 37.2¬∞C.",
                    correctDiagnosis: "Flagellated protozoa giardiasis",
                    organism: "Flagellated protozoa",
                    differentials: ["Flagellated protozoa giardiasis", "Cryptosporidium", "Viral gastroenteritis", "Bacterial gastroenteritis", "IBD", "Celiac disease", "Lactose intolerance", "C. difficile", "Traveler's diarrhea", "Malabsorption"],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Mildly dehydrated, tender abdomen", interpretation: "Chronic diarrhea" },
                        { name: "Stool O&P", cost: 60, result: "Flagellated trophozoites with characteristic motility", interpretation: "Flagellated protozoa" },
                        { name: "Stool Antigen", cost: 65, result: "Positive for intestinal protozoa", interpretation: "Confirms intestinal protozoa" },
                        { name: "CBC", cost: 55, result: "Mild eosinophilia", interpretation: "Parasitic infection" }
                    ],
                    minimumTests: ["Stool O&P"],
                    treatments: [
                        { name: "Metronidazole", correct: true, explanation: "First-line for giardiasis" },
                        { name: "Tinidazole", correct: false, explanation: "Alternative nitroimidazole" },
                        { name: "Nitazoxanide", correct: false, explanation: "Alternative antiparasitic" },
                        { name: "Paromomycin", correct: false, explanation: "For pregnancy-safe treatment" },
                        { name: "Albendazole", correct: false, explanation: "Benzimidazole alternative" },
                        { name: "Quinacrine", correct: false, explanation: "Historical treatment" },
                    ],
                    classicClue: "Hiker with chronic diarrhea after stream water",
                    keyTest: "Stool O&P with falling leaf motility",
                    firstLineTreatment: "Metronidazole",
                    whyCorrect: "Giardia causes chronic diarrhea from untreated water.",
                    whyWrong: ["Cryptosporidium shows different oocysts", "Viral is self-limited"]
                },
                {
                    id: 17,
                    initialPresentation: "Mother about her 8-year-old: 'She's been uncomfortable and not sleeping well.'",
                    physicalExam: "Healthy child, perianal excoriation. Vitals normal.",
                    correctDiagnosis: "Enterobius vermicularis (pinworm)",
                    organism: "Enterobius vermicularis",
                    differentials: ["Enterobius vermicularis (pinworm)", "Perianal dermatitis", "Hemorrhoids", "Anal fissure", "Candida", "Contact dermatitis", "Eczema", "Threadworm", "Scabies", "Allergic reaction"],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Healthy child, perianal excoriation", interpretation: "Perianal pruritus" },
                        { name: "Scotch Tape Test", cost: 50, result: "Elongated transparent eggs", interpretation: "Pinworm eggs" },
                        { name: "Stool O&P", cost: 60, result: "Negative", interpretation: "Eggs not in stool" }
                    ],
                    minimumTests: ["Scotch Tape Test"],
                    treatments: [
                        { name: "Mebendazole", correct: true, explanation: "First-line anthelminthic" },
                        { name: "Albendazole", correct: false, explanation: "Alternative benzimidazole" },
                        { name: "Pyrantel pamoate", correct: false, explanation: "OTC alternative" },
                        { name: "Ivermectin", correct: false, explanation: "Broad-spectrum antiparasitic" },
                        { name: "Praziquantel", correct: false, explanation: "For cestode infections" },
                        { name: "Mebendazole + Albendazole", correct: false, explanation: "Combination not needed" },
                    ],
                    classicClue: "Child with nighttime perianal itching",
                    keyTest: "Scotch tape showing pinworm eggs",
                    firstLineTreatment: "Mebendazole",
                    whyCorrect: "Pinworm causes nighttime itching when females lay eggs.",
                    whyWrong: ["Dermatitis wouldn't show eggs", "Hemorrhoids rare in kids"]
                },
                {
                    id: 18,
                    initialPresentation: "22-year-old: 'I noticed something odd. It started after I finished antibiotics.'",
                    physicalExam: "White plaques on tongue/mucosa, adherent, red base when scraped.",
                    correctDiagnosis: "Candida albicans oral thrush",
                    organism: "Candida albicans",
                    differentials: ["Candida albicans oral thrush", "Oral leukoplakia", "Oral lichen planus", "Strep pharyngitis", "Viral pharyngitis", "Oral hairy leukoplakia", "Chemical burn", "Milk residue", "Aphthous ulcers", "Oral cancer"],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "White plaques, red base when scraped", interpretation: "Oral candidiasis" },
                        { name: "KOH Prep", cost: 55, result: "Pseudohyphae and budding yeast", interpretation: "Yeast infection" },
                        { name: "Fungal Culture", cost: 60, result: "Yeast with pseudohyphae", interpretation: "Confirms yeast" }
                    ],
                    minimumTests: ["KOH Prep"],
                    treatments: [
                        { name: "Nystatin or Fluconazole", correct: true, explanation: "First-line topical or systemic options" },
                        { name: "Clotrimazole troches", correct: false, explanation: "Alternative topical" },
                        { name: "Itraconazole", correct: false, explanation: "Alternative azole" },
                        { name: "Amphotericin B", correct: false, explanation: "Reserved for severe infections" },
                        { name: "Caspofungin", correct: false, explanation: "Echinocandin for invasive disease" },
                        { name: "Fluconazole + Nystatin", correct: false, explanation: "Combination not necessary" },
                    ],
                    classicClue: "White oral plaques after antibiotics",
                    keyTest: "KOH prep with pseudohyphae",
                    firstLineTreatment: "Nystatin or Fluconazole",
                    whyCorrect: "Candida thrush follows antibiotic use.",
                    whyWrong: ["Leukoplakia doesn't scrape off", "Strep has tonsillar exudates"]
                },
                {
                    id: 19,
                    initialPresentation: "70-year-old on chemotherapy: 'I've been feeling really weak. Not good.'",
                    physicalExam: "Ill-appearing, cachectic, crackles. Fever 38.9¬∞C, O2 90%.",
                    correctDiagnosis: "Aspergillus pneumonia",
                    organism: "Aspergillus",
                    differentials: ["Aspergillus pneumonia", "Pneumocystis", "Bacterial pneumonia", "Viral pneumonia", "Tuberculosis", "Lung cancer", "PE", "Heart failure", "Mucormycosis", "Cryptococcus"],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Ill, cachectic, crackles", interpretation: "Pneumonia" },
                        { name: "Chest X-ray", cost: 70, result: "Cavitary lesion with air-crescent sign", interpretation: "Fungal infection" },
                        { name: "Sputum Culture", cost: 60, result: "Septate hyphae with acute-angle branching", interpretation: "Filamentous fungus" },
                        { name: "Galactomannan", cost: 75, result: "Positive", interpretation: "Fungal antigen" }
                    ],
                    minimumTests: ["Chest X-ray", "Sputum Culture"],
                    treatments: [
                        { name: "Voriconazole", correct: true, explanation: "First-line for invasive aspergillosis" },
                        { name: "Amphotericin B", correct: false, explanation: "Alternative but more toxic" },
                        { name: "Isavuconazole", correct: false, explanation: "Newer azole alternative" },
                        { name: "Posaconazole", correct: false, explanation: "Prophylaxis or salvage therapy" },
                        { name: "Caspofungin", correct: false, explanation: "Echinocandin salvage therapy" },
                        { name: "Voriconazole + Caspofungin", correct: false, explanation: "Combination for refractory cases" },
                    ],
                    classicClue: "Neutropenic with cavitary lesion and air-crescent sign",
                    keyTest: "Air-crescent sign",
                    firstLineTreatment: "Voriconazole",
                    whyCorrect: "Aspergillus causes invasive pneumonia in neutropenic patients.",
                    whyWrong: ["PCP shows diffuse infiltrates", "Bacterial wouldn't show hyphae"]
                },
                {
                    id: 20,
                    initialPresentation: "45-year-old HIV-positive patient: 'I've had this problem for a couple weeks now.'",
                    physicalExam: "Mild confusion, CN VI palsy, nuchal rigidity. Fever 38.1¬∞C.",
                    correctDiagnosis: "Cryptococcus neoformans meningitis",
                    organism: "Cryptococcus neoformans",
                    differentials: ["Cryptococcus neoformans meningitis", "Toxoplasma encephalitis", "TB meningitis", "Bacterial meningitis", "Viral meningitis", "Brain abscess", "CNS lymphoma", "PML", "CMV encephalitis", "Neurosyphilis"],
                    tests: [
                        { name: "Physical Exam", cost: 0, result: "Confusion, CN VI palsy, nuchal rigidity", interpretation: "Meningitis" },
                        { name: "Lumbar Puncture", cost: 70, result: "High opening pressure, lymphocytes, low glucose", interpretation: "Chronic meningitis" },
                        { name: "India Ink Stain", cost: 55, result: "Encapsulated budding yeast", interpretation: "Encapsulated yeast" },
                        { name: "Cryptococcal Antigen", cost: 65, result: "Positive", interpretation: "Confirms encapsulated yeast" }
                    ],
                    minimumTests: ["Lumbar Puncture", "India Ink Stain"],
                    treatments: [
                        { name: "Amphotericin B + Flucytosine", correct: true, explanation: "Induction therapy for crypto meningitis" },
                        { name: "Fluconazole", correct: false, explanation: "Used for consolidation not induction" },
                        { name: "Amphotericin B + Fluconazole", correct: false, explanation: "Not standard induction" },
                        { name: "Voriconazole", correct: false, explanation: "Not active against Cryptococcus" },
                        { name: "Itraconazole", correct: false, explanation: "Not for meningitis" },
                        { name: "Liposomal Amphotericin B", correct: false, explanation: "Less toxic formulation but insufficient" },
                    ],
                    classicClue: "HIV patient with subacute meningitis and high opening pressure",
                    keyTest: "India ink showing encapsulated budding yeast",
                    firstLineTreatment: "Amphotericin B + Flucytosine",
                    whyCorrect: "Cryptococcus causes meningitis in AIDS with CD4 <100.",
                    whyWrong: ["Toxoplasma causes brain lesions", "TB shows AFB not yeast"]
                }
            ];

            // Audio functions
            function initAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            function playSFX(type) {
                if (!state.sfxEnabled || !state.audioEnabled) return;
                try {
                    initAudio();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    gainNode.gain.setValueAtTime(state.volume * 0.3, audioContext.currentTime);
                    
                    switch(type) {
                        case 'test':
                            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.1);
                            break;
                        case 'correct':
                            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                            break;
                        case 'incorrect':
                            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                            break;
                        case 'transition':
                            oscillator.frequency.setValueAtTime(261.63, audioContext.currentTime);
                            break;
                    }
                    
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch(e) {
                    console.log('Audio error:', e);
                }
            }

            function toggleSFX() {
                state.sfxEnabled = !state.sfxEnabled;
                document.getElementById('sfxBtn').textContent = state.sfxEnabled ? 'üîä ON' : 'üîá OFF';
            }

            function toggleAudio() {
                state.audioEnabled = !state.audioEnabled;
                document.getElementById('audioBtn').textContent = state.audioEnabled ? 'üîä Audio: ON' : 'üîá Audio: OFF';
            }

            function setVolume(value) {
                state.volume = value / 100;
                if (musicGain) {
                    musicGain.gain.setValueAtTime(state.volume * 0.1, audioContext.currentTime);
                }
            }

            function toggleContrast() {
                document.body.classList.toggle('high-contrast');
            }
            function togglePresentationView() {
                state.showInitialPresentation = !state.showInitialPresentation;
                renderDiagnosisStage();
            }


            // Utility functions
            function getWeightedCase() {
                // Filter out already used cases
                let availableCases = casesDatabase.filter(c => !state.usedCases.includes(c.id));
                
                // If all cases have been used, reset the pool
                if (availableCases.length === 0) {
                    state.usedCases = [];
                    availableCases = [...casesDatabase];
                }
                
                let cases = [...availableCases];
                
                // Apply mistake weighting
                if (Object.keys(state.mistakeMemory).length > 0) {
                    const weightedCases = [];
                    cases.forEach(c => {
                        const baseWeight = 1;
                        const mistakeWeight = state.mistakeMemory[c.organism] || 0;
                        const totalWeight = baseWeight + mistakeWeight;
                        
                        for (let i = 0; i < totalWeight; i++) {
                            weightedCases.push(c);
                        }
                    });
                    cases = weightedCases;
                }
                
                const selectedCase = cases[Math.floor(Math.random() * cases.length)];
                
                // Mark this case as used
                state.usedCases.push(selectedCase.id);
                
                return selectedCase;
            }
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            function getTestIcon(testName) {
                const icons = {
                    'Physical Exam': 'ü©∫', 'Lumbar Puncture': 'üíâ', 'Gram Stain': 'üî¨',
                    'Blood Culture': 'üß™', 'CBC': 'ü©∏', 'CT Head': 'üß†', 'CT Scan': 'üîç',
                    'Chest X-ray': 'ü´Å', 'X-ray': 'üì∑', 'Sputum Gram Stain': 'üî¨',
                    'Sputum Culture': 'üß´', 'Urinalysis': 'üß™', 'Urine Culture': 'üß´',
                    'Vaginal/Rectal Culture': 'üß´', 'Rapid Strep Test': '‚ö°',
                    'Throat Culture': 'üß´', 'Blood Cultures': 'üß™', 'Echocardiogram': '‚ù§Ô∏è',
                    'CSF Gram Stain': 'üî¨', 'CSF Culture': 'üß´', 'Pregnancy Test': 'üß™',
                    'STI Panel': 'üß™', 'ABG': 'ü´Å', 'Stool Culture': 'üß´',
                    'Stool O&P': 'üî¨', 'HIV Test': 'üß™', 'Lateral Neck X-ray': 'üì∑',
                    'Joint Aspirate Culture': 'üß´', 'KOH Prep': 'üî¨',
                    'Fungal Culture': 'üß´', 'Scotch Tape Test': 'üî¨',
                    'Stool Antigen': 'üß™', 'Galactomannan': 'üß™',
                    'India Ink Stain': 'üî¨', 'Cryptococcal Antigen': 'üß™',
                    'CD4 Count': 'üß™', 'Electrolytes': 'üß™', 'CT Chest': 'üîç'
                };
                return icons[testName] || 'üß™';
            }



            function updateScore(points) {
                state.score += points;
                if (state.score < 0) state.score = 0;
                const scoreEl = document.getElementById('score');
                if (scoreEl) {
                    scoreEl.textContent = state.score;
                }
                updateRating();
            }

            function updateRating() {
                const rating = Math.min(5, Math.max(0, Math.floor(state.score / 200)));
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, i) => {
                    if (i < rating) {
                        star.classList.add('filled');
                        star.textContent = '‚òÖ';
                    } else {
                        star.classList.remove('filled');
                        star.textContent = '‚òÜ';
                    }
                });
            }

            function updateCaseCounter() {
                const counter = document.getElementById('caseCounter');
                if (counter) {
                    counter.textContent = state.casesCompleted;
                }
            }

            function updateDayCounter() {
                const counter = document.getElementById('dayCounter');
                if (counter) {
                    counter.textContent = state.currentDay;
                }
            }

            function updateTodayCounter() {
                const counter = document.getElementById('todayCounter');
                if (counter) {
                    counter.textContent = `${state.casesCompletedToday}/${state.casesPerDay}`;
                }
            }

            function updateStreak(correct) {
                if (correct) {
                    state.streak++;
                } else {
                    state.streak = 0;
                }
                const streakEl = document.getElementById('streak');
                if (streakEl) {
                    streakEl.textContent = state.streak;
                }
            }

            function showFeedback(message, type) {
                const feedback = document.createElement('div');
                feedback.className = `feedback-message feedback-${type}`;
                feedback.textContent = message;
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    feedback.remove();
                }, 3000);
            }

            function showModal(title, content) {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modalContent');
                modalContent.innerHTML = `<h2>${title}</h2>${content}`;
                modal.classList.add('active');
            }

            function closeModal() {
                document.getElementById('modal').classList.remove('active');
            }

            function showAbout() {
                showModal('About This Game', `
                    <div class="about-panel">
                        <p>Hospital Hero: Microbiology Mastery is an educational game designed to help medical students master clinical microbiology.</p>
                        <p><strong>Cases Generated:</strong> ${casesDatabase.length} cases from comprehensive microbiology curriculum</p>
                        <p><strong>Features:</strong></p>
                        <ul>
                            <li>Realistic clinical vignettes based on authoritative medical content</li>
                            <li>Test ordering with efficiency scoring</li>
                            <li>Differential diagnosis practice</li>
                            <li>Treatment selection</li>
                            <li>Lab interpretation challenges</li>
                            <li>Mistake memory system for spaced repetition</li>
                            <li>Post-case NBME-style takeaway cards</li>
                        </ul>
                        <p><strong>Keyboard Shortcuts:</strong></p>
                        <ul>
                            <li>Tab: Navigate through options</li>
                            <li>Enter/Space: Select option</li>
                        </ul>
                        <p><strong>Scoring:</strong> You start with $100. Tests cost points. Correct diagnoses and treatments earn points. Your hospital rating is based on your score!</p>
                        <button class="btn btn-primary" onclick="game.closeModal()">Close</button>
                    </div>
                `);
            }

            // Stage rendering
            function renderDiagnosisStage() {
                const caseData = state.currentCase;
                playSFX('transition');
                
                const container = document.getElementById('gameContainer');
                container.innerHTML = `
                    <div class="game-board">
                        <div class="hospital-room">
                            <div class="room-header">Patient Encounter</div>
                            
                            <div class="patient-visual">
                                ${state.physicalExamDone ? `
                                    <div class="vital-monitor">
                                        <svg viewBox="0 0 80 30" class="heartbeat-line">
                                            <polyline points="0,15 10,15 15,5 20,25 25,15 80,15"/>
                                        </svg>
                                        <div class="monitor-text">HR: 98</div>
                                    </div>
                                    <div class="patient-figure">
                                        <div class="patient-head">
                                            <div class="patient-hair"></div>
                                            <div class="patient-face">
                                                <div class="patient-eye patient-eye-closed-left"></div>
                                                <div class="patient-eye patient-eye-closed-right"></div>
                                            </div>
                                        </div>
                                        <div class="patient-body-torso"></div>
                                        <div class="patient-blanket">
                                            <div class="blanket-folds"></div>
                                        </div>
                                        <div class="patient-arm patient-arm-left"></div>
                                        <div class="patient-arm patient-arm-right"></div>
                                    </div>
                                    <div class="patient-bed"></div>
                                ` : `
                                    <div style="position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center;">
                                        <div style="width: 60px; height: 60px; background: #f0d4a8; border-radius: 50%; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                                        <div style="width: 80px; height: 100px; background: #6b9bd1; border-radius: 10px 10px 40px 40px; position: relative;">
                                            <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: white; width: 30px; height: 3px; border-radius: 2px;"></div>
                                        </div>
                                        <div style="margin-top: 10px; background: white; padding: 8px 15px; border-radius: 15px; color: #333; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                            üë©‚Äç‚öïÔ∏è Nurse
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                            <div class="vignette">
                                <div class="vignette-title">${state.showInitialPresentation ? 'Initial Presentation:' : (state.physicalExamDone ? 'Physical Exam Findings:' : 'Initial Presentation:')}</div>
                                <p>${state.showInitialPresentation ? caseData.initialPresentation : (state.physicalExamDone ? caseData.physicalExam : caseData.initialPresentation)}</p>
                            </div>
                            
                            <div id="toggleButtonArea"></div>
                            
                            <div class="test-menu">
                                <h3>Order Tests (Each costs points)</h3>
                                <div class="test-grid" id="testGrid"></div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="game.finalizeDiagnosis()" id="finalizeBtn" disabled>
                                    üîí Lock In Diagnosis
                                </button>
                            </div>
                        </div>
                        
                        <div class="differential-notepad">
                            <div class="notepad-header">üìã Differential Diagnosis</div>
                            <p style="font-size: 0.9em; margin-bottom: 10px;">Click to cross off. Select and lock in your diagnosis.</p>
                            <div id="differentialList"></div>
                        </div>
                    </div>
                `;
                
                
                // Add toggle button if physical exam is done
                if (state.physicalExamDone) {
                    document.getElementById('toggleButtonArea').innerHTML = `
                        <div style="margin: 10px 0; text-align: center;">
                            <button class="btn btn-secondary" onclick="game.togglePresentationView()" style="font-size: 0.9em; padding: 8px 16px;">
                                ${state.showInitialPresentation ? 'üëÅÔ∏è Show Physical Exam' : 'üìã Review Initial Presentation'}
                            </button>
                        </div>
                    `;
                }
                
                renderTests();
                renderDifferentials();
            }

            function renderTests() {
                const testGrid = document.getElementById('testGrid');
                const tests = state.currentCase.tests;
                
                testGrid.innerHTML = tests.map((test, idx) => {
                    const isOrdered = state.orderedTests.includes(test.name);
                    const canAfford = state.score >= test.cost || isOrdered;
                    const isDisabled = !canAfford && !isOrdered;
                    const isPhysicalExam = test.name === "Physical Exam";
                    
                    return `
                        <div class="test-card ${isOrdered ? 'ordered' : ''} ${isDisabled ? 'disabled' : ''}" 
                             onclick="${isDisabled ? '' : `game.orderTest(${idx})`}" 
                             tabindex="${isDisabled ? '-1' : '0'}"
                             onkeypress="${isDisabled ? '' : `if(event.key==='Enter')game.orderTest(${idx})`}"
                             style="${isDisabled ? 'cursor: not-allowed; opacity: 0.5;' : ''}">
                            <div style="display: flex; align-items: center; gap: 8px;"><div style="font-size: 1.5em;">${getTestIcon(test.name)}</div><div class="test-name">${test.name}</div></div>
                            <div class="test-cost">Cost: $${test.cost}${isDisabled ? ' üîí' : ''}</div>
                            ${isOrdered && !isPhysicalExam ? `
                                <div class="test-result">
                                    <strong>Result:</strong> ${test.result}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            function renderDifferentials() {
                const diffList = document.getElementById('differentialList');
                if (!state.currentCase.shuffledDifferentials) {
                    state.currentCase.shuffledDifferentials = shuffleArray(state.currentCase.differentials);
                }
                const diffs = state.currentCase.shuffledDifferentials;
                
                diffList.innerHTML = diffs.map((diag, idx) => {
                    const isCrossed = state.crossedDiagnoses.includes(diag);
                    const isLocked = state.lockedDiagnosis === diag;
                    return `
                        <div class="diagnosis-item ${isCrossed ? 'crossed' : ''} ${isLocked ? 'locked' : ''}"
                             onclick="game.toggleDiagnosis('${diag}')"
                             tabindex="0"
                             onkeypress="if(event.key==='Enter')game.toggleDiagnosis('${diag}')">
                            <span>${diag}</span>
                            ${!isCrossed && !isLocked ? `
                                <button class="lock-btn" onclick="event.stopPropagation(); game.selectDiagnosis('${diag}')">
                                    Select
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            function orderTest(testIdx) {
                const test = state.currentCase.tests[testIdx];
                
                if (state.orderedTests.includes(test.name)) {
                    return;
                }
                
                // Check if player can afford the test
                if (state.score < test.cost) {
                    showFeedback(`Insufficient funds! Need $${test.cost}, have $${state.score}`, 'error');
                    playSFX('incorrect');
                    return;
                }
                
                playSFX('test');
                updateScore(-test.cost);
                state.orderedTests.push(test.name);
                
                // Switch to patient visual if Physical Exam ordered
                if (test.name === "Physical Exam") {
                    state.physicalExamDone = true;
                }
                
                showFeedback(`Ordered: ${test.name} (-$${test.cost})`, 'info');
                renderTests();
                renderDiagnosisStage(); // Re-render to update visual
            }


            function toggleDiagnosis(diagnosis) {
                if (state.lockedDiagnosis === diagnosis) {
                    return;
                }
                
                const idx = state.crossedDiagnoses.indexOf(diagnosis);
                if (idx > -1) {
                    state.crossedDiagnoses.splice(idx, 1);
                } else {
                    state.crossedDiagnoses.push(diagnosis);
                }
                renderDifferentials();
            }

            function selectDiagnosis(diagnosis) {
                state.lockedDiagnosis = diagnosis;
                document.getElementById('finalizeBtn').disabled = false;
                renderDifferentials();
                showFeedback('Diagnosis selected. Click "Lock In Diagnosis" to proceed.', 'info');
            }

            function finalizeDiagnosis() {
                if (!state.lockedDiagnosis) {
                    showFeedback('Please select a diagnosis first!', 'error');
                    return;
                }
                
                const isCorrect = state.lockedDiagnosis === state.currentCase.correctDiagnosis;
                
                // Store diagnosis result without revealing it
                state.diagnosisCorrect = isCorrect;
                
                if (!isCorrect) {
                    // Track incorrect diagnosis for mistake memory
                    state.mistakesThisCase++;
                    state.lawsuitsToday++;
                    const organism = state.currentCase.organism;
                    state.mistakeMemory[organism] = (state.mistakeMemory[organism] || 0) + 2;
                }
                
                // Proceed to treatment without feedback
                playSFX('transition');
                state.stage = 'treatment';
                setTimeout(renderTreatmentStage, 500);
            }

            function renderTreatmentStage() {
                playSFX('transition');
                state.stage = 'treatment';
                
                const container = document.getElementById('gameContainer');
                container.innerHTML = `
                    <div class="hospital-room" style="max-width: 1000px; margin: 0 auto;">
                        <div class="room-header">Select Treatment</div>
                        <div style="background: rgba(37, 99, 235, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 1.1em;">
                                <strong>You selected:</strong> ${state.lockedDiagnosis}
                            </p>
                        </div>
                        <p style="margin-bottom: 20px;">Choose the best treatment for this patient:</p>
                        <div class="treatment-grid" id="treatmentGrid"></div>
                    </div>
                `;
                
                renderTreatments();
            }

            function renderTreatments() {
                const grid = document.getElementById('treatmentGrid');
                if (!state.currentCase.shuffledTreatments) {
                    state.currentCase.shuffledTreatments = shuffleArray(state.currentCase.treatments);
                }
                const treatments = state.currentCase.shuffledTreatments;
                
                grid.innerHTML = treatments.map((tx, idx) => `
                    <div class="treatment-card" 
                         onclick="game.selectTreatment(${idx})"
                         tabindex="0"
                         onkeypress="if(event.key==='Enter')game.selectTreatment(${idx})">
                        <div class="treatment-name">${tx.name}</div>
                        <div class="treatment-description">Click to select</div>
                    </div>
                `).join('');
            }

            function selectTreatment(txIdx) {
                const treatments = state.currentCase.shuffledTreatments || state.currentCase.treatments;
                const treatment = treatments[txIdx];
                const treatmentCorrect = treatment.correct;
                const diagnosisCorrect = state.diagnosisCorrect;
                
                // Calculate total outcome with new scoring system
                let totalPoints = 0;
                let feedbackMessages = [];
                
                // Determine outcome
                const bothCorrect = diagnosisCorrect && treatmentCorrect;
                const bothWrong = !diagnosisCorrect && !treatmentCorrect;
                const oneWrong = !bothCorrect && !bothWrong;
                
                // Apply scoring
                if (bothCorrect) {
                    totalPoints = 150;
                    feedbackMessages.push('‚úì Diagnosis correct');
                    feedbackMessages.push('‚úì Treatment correct');
                    updateStreak(true);
                } else if (bothWrong) {
                    totalPoints = -200;
                    feedbackMessages.push('‚úó Diagnosis incorrect');
                    feedbackMessages.push('‚úó Treatment incorrect');
                    updateStreak(false);
                    state.mistakesThisCase++;
                    state.lawsuitsToday++;
                    const organism = state.currentCase.organism;
                    state.mistakeMemory[organism] = (state.mistakeMemory[organism] || 0) + 1;
                } else {
                    // One correct, one wrong = $0
                    totalPoints = 0;
                    if (diagnosisCorrect) {
                        feedbackMessages.push('‚úì Diagnosis correct');
                        feedbackMessages.push('‚úó Treatment incorrect');
                    } else {
                        feedbackMessages.push('‚úó Diagnosis incorrect');
                        feedbackMessages.push('‚úì Treatment correct');
                    }
                    updateStreak(false);
                    state.mistakesThisCase++;
                    state.lawsuitsToday++;
                    const organism = state.currentCase.organism;
                    state.mistakeMemory[organism] = (state.mistakeMemory[organism] || 0) + 1;
                }
                
                // Apply total score change
                updateScore(totalPoints);
                
                if (bothCorrect) {
                    playSFX('correct');
                    showModal('Perfect Case!', `
                        <div class="feedback-success" style="position: static;">
                            <p style="font-size: 1.5em; margin-bottom: 15px;">üéâ Excellent Work!</p>
                            <div style="text-align: left; margin-bottom: 15px;">
                                ${feedbackMessages.map(msg => `<p style="margin: 5px 0; font-size: 1.1em;">${msg}</p>`).join('')}
                            </div>
                            <p style="font-size: 1.4em; font-weight: bold; color: var(--success-green);">
                                +$${totalPoints}
                            </p>
                            <button class="btn btn-primary" onclick="game.closeModal(); game.state.casesCompleted++; game.state.casesCompletedToday++; game.updateCaseCounter(); game.updateTodayCounter(); if (game.state.casesCompletedToday >= game.state.casesPerDay) { game.renderDayComplete(); } else { game.renderLearningStage(); }">
                                Continue
                            </button>
                        </div>
                    `);
                } else {
                    playSFX('incorrect');
                    const correctDiagnosis = state.currentCase.correctDiagnosis;
                    const correctTreatment = state.currentCase.treatments.find(t => t.correct);
                    
                    showModal('Case Review', `
                        <div class="feedback-error" style="position: static;">
                            <p style="font-size: 1.2em; margin-bottom: 15px;">üìã Review Results</p>
                            
                            <div style="text-align: left; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                <p style="margin: 5px 0;"><strong>Your diagnosis:</strong> ${state.lockedDiagnosis}</p>
                                <p style="margin: 5px 0; color: ${diagnosisCorrect ? 'var(--success-green)' : 'var(--danger-red)'}">
                                    ${diagnosisCorrect ? '‚úì Correct' : '‚úó Incorrect'}
                                </p>
                                ${!diagnosisCorrect ? `<p style="margin: 5px 0;"><strong>Correct diagnosis:</strong> ${correctDiagnosis}</p>` : ''}
                            </div>
                            
                            <div style="text-align: left; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                <p style="margin: 5px 0;"><strong>Your treatment:</strong> ${treatment.name}</p>
                                <p style="margin: 5px 0; color: ${treatmentCorrect ? 'var(--success-green)' : 'var(--danger-red)'}">
                                    ${treatmentCorrect ? '‚úì Correct' : '‚úó Incorrect'}
                                </p>
                                ${!treatmentCorrect ? `
                                    <p style="margin: 5px 0;"><strong>Why incorrect:</strong> ${treatment.explanation}</p>
                                    <p style="margin: 5px 0;"><strong>Correct treatment:</strong> ${correctTreatment.name}</p>
                                    <p style="margin: 5px 0;"><strong>Why:</strong> ${correctTreatment.explanation}</p>
                                ` : ''}
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                ${feedbackMessages.map(msg => `<p style="margin: 5px 0; font-size: 1.1em;">${msg}</p>`).join('')}
                            </div>
                            
                            <p style="font-size: 1.4em; font-weight: bold; color: ${totalPoints > 0 ? 'var(--success-green)' : totalPoints < 0 ? 'var(--danger-red)' : '#FFA500'};">
                                ${totalPoints > 0 ? '+' : ''}$${totalPoints}
                            </p>
                            
                            <div class="mistake-reminder">
                                ‚ö†Ô∏è This organism will appear again to help you learn!
                            </div>
                            
                            <button class="btn btn-primary" onclick="game.closeModal(); game.state.casesCompleted++; game.state.casesCompletedToday++; game.updateCaseCounter(); game.updateTodayCounter(); if (game.state.casesCompletedToday >= game.state.casesPerDay) { game.renderDayComplete(); } else { game.renderLearningStage(); }">
                                Continue
                            </button>
                        </div>
                    `);
                }
            }

            function renderLearningStage() {
                playSFX('transition');
                state.stage = 'learning';
                
                const caseData = state.currentCase;
                
                const orderedCount = state.orderedTests.length;
                const minRequired = caseData.minimumTests.length;
                let badge = '';
                let badgeClass = '';
                
                if (orderedCount === minRequired) {
                    badge = 'Gold Badge - Excellent Efficiency!';
                    badgeClass = 'badge-gold';
                } else if (orderedCount <= minRequired + 2) {
                    badge = 'Silver Badge - Good Efficiency';
                    badgeClass = 'badge-silver';
                } else {
                    badge = 'Bronze Badge - Consider Fewer Tests';
                    badgeClass = 'badge-bronze';
                }
                
                const container = document.getElementById('gameContainer');
                container.innerHTML = `
                    <div class="learning-card">
                        <div class="learning-title">üéì Case Complete!</div>
                        
                        <div class="efficiency-badge ${badgeClass}">
                            ${badge}
                        </div>
                        <p style="text-align: center; margin-top: 10px;">
                            You ordered ${orderedCount} tests. Minimum needed: ${minRequired}
                        </p>
                        
                        <h3 style="margin-top: 30px; color: var(--primary-blue);">NBME Takeaway Card</h3>
                        
                        <div class="takeaway-section">
                            <div class="takeaway-label">Classic Vignette Clue:</div>
                            <p>${caseData.classicClue}</p>
                        </div>
                        
                        <div class="takeaway-section">
                            <div class="takeaway-label">Key Distinguishing Test:</div>
                            <p>${caseData.keyTest}</p>
                        </div>
                        
                        <div class="takeaway-section">
                            <div class="takeaway-label">Correct Diagnosis:</div>
                            <p><strong>${caseData.correctDiagnosis}</strong></p>
                        </div>
                        
                        <div class="takeaway-section">
                            <div class="takeaway-label">First-Line Treatment:</div>
                            <p><strong>${caseData.firstLineTreatment}</strong></p>
                        </div>
                        
                        <div class="explanation-replay">
                            <div class="collapsible-header" onclick="game.toggleExplanation()">
                                <span>üìö Explanation & Differentials</span>
                                <span id="toggleIcon">‚ñº</span>
                            </div>
                            <div class="collapsible-content" id="explanationContent">
                                <div class="takeaway-section">
                                    <div class="takeaway-label">Why This Diagnosis Fits:</div>
                                    <p>${caseData.whyCorrect}</p>
                                </div>
                                
                                <div class="takeaway-section">
                                    <div class="takeaway-label">Common Differentials & Why They're Wrong:</div>
                                    <ul>
                                        ${caseData.whyWrong.map(w => `<li>${w}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-success btn-lg" onclick="game.nextCase()" style="font-size: 1.2em; padding: 15px 40px;">
                                Continue to Next Case ‚ûú
                            </button>
                        </div>
                    </div>
                `;
            }
            function renderDayComplete() {
                playSFX('transition');
                
                const container = document.getElementById('gameContainer');
                const wasFlawless = state.lawsuitsToday === 0;
                
                container.innerHTML = '<div class="learning-card" style="max-width: 600px;">' +
                    '<div class="learning-title">' + (wasFlawless ? 'üèÜ Perfect Day!' : 'üìã Day Complete') + '</div>' +
                    '<div style="text-align: center; margin: 30px 0;">' +
                        '<div style="font-size: 3em; margin-bottom: 10px;">' + (wasFlawless ? '‚ú®' : 'üìä') + '</div>' +
                        '<h2 style="color: var(--primary-blue); margin-bottom: 20px;">Day ' + state.currentDay + ' Summary</h2>' +
                    '</div>' +
                    '<div class="takeaway-section">' +
                        '<div class="takeaway-label">Cases Completed:</div>' +
                        '<p style="font-size: 1.5em;">' + state.casesCompletedToday + '</p>' +
                    '</div>' +
                    '<div class="takeaway-section" style="background: ' + (wasFlawless ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)') + ';">' +
                        '<div class="takeaway-label">‚öñÔ∏è Lawsuits Received:</div>' +
                        '<p style="font-size: 2em; font-weight: bold; color: ' + (wasFlawless ? 'var(--success-green)' : 'var(--danger-red)') + ';">' +
                            state.lawsuitsToday +
                        '</p>' +
                        (wasFlawless ? 
                            '<p style="color: var(--success-green); margin-top: 10px;">üéâ No errors! Excellent work, Doctor!</p>' : 
                            '<p style="color: var(--text-medium); margin-top: 10px;">Review the cases where you made errors to improve.</p>') +
                    '</div>' +
                    '<div class="takeaway-section">' +
                        '<div class="takeaway-label">Current Score:</div>' +
                        '<p style="font-size: 1.5em;">$' + state.score + '</p>' +
                    '</div>' +
                    '<div style="text-align: center; margin-top: 40px;">' +
                        '<button class="btn btn-success" onclick="game.startNextDay()" style="font-size: 1.3em; padding: 15px 40px;">' +
                            'Start Day ' + (state.currentDay + 1) + ' ‚Üí' +
                        '</button>' +
                    '</div>' +
                '</div>';
            }


            function toggleExplanation() {
                const content = document.getElementById('explanationContent');
                const icon = document.getElementById('toggleIcon');
                
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    icon.textContent = '‚ñº';
                } else {
                    content.classList.add('open');
                    icon.textContent = '‚ñ≤';
                }
            }

            
            function startNextDay() {
                state.currentDay++;
                state.casesCompletedToday = 0;
                state.lawsuitsToday = 0;
                updateDayCounter();
                updateTodayCounter();
                nextCase();
            }

            function nextCase() {
                state.orderedTests = [];
                state.crossedDiagnoses = [];
                state.lockedDiagnosis = null;
                state.diagnosisCorrect = null;
                state.physicalExamDone = false;
                state.showInitialPresentation = false;
                state.mistakesThisCase = 0;
                state.stage = 'diagnosis';
                
                state.currentCase = getWeightedCase();
                
                renderDiagnosisStage();
            }

            function initGame() {
                console.log('Game initializing...');
                console.log('Cases available:', casesDatabase.length);
                
                updateCaseCounter();
                updateDayCounter();
                updateTodayCounter();
                updateRating();
                
                state.currentCase = getWeightedCase();
                console.log('Starting with case:', state.currentCase.id);
                
                renderDiagnosisStage();
                
                setTimeout(() => {
                    showFeedback('Welcome to Hospital Hero! Diagnose patients and improve your rating!', 'info');
                }, 500);
            }

            // Event listeners
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target.id === 'modal') {
                    closeModal();
                }
            });

            // Public API
            return {
                // Expose necessary functions
                state: state,
                toggleAudio: toggleAudio,
                
                toggleSFX: toggleSFX,
                setVolume: setVolume,
                toggleContrast: toggleContrast,
                togglePresentationView: togglePresentationView,
                startNextDay: startNextDay,
                renderDayComplete: renderDayComplete,
                showAbout: showAbout,
                closeModal: closeModal,
                orderTest: orderTest,
                
                
                toggleDiagnosis: toggleDiagnosis,
                selectDiagnosis: selectDiagnosis,
                finalizeDiagnosis: finalizeDiagnosis,
                selectTreatment: selectTreatment,
                toggleExplanation: toggleExplanation,
                nextCase: nextCase,
                renderTreatmentStage: renderTreatmentStage,
                renderLearningStage: renderLearningStage,
                updateCaseCounter: updateCaseCounter,
                updateDayCounter: updateDayCounter,
                updateTodayCounter: updateTodayCounter,
                init: initGame
            };
        })();

        // Start the game when page loads
        window.addEventListener('load', () => {
            console.log('Page loaded, starting game...');
            game.init();
        });
    </script>
</body>
</html>
